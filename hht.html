<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Horse Health Tracker</title>
    <style>
        /* General Styling */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacMacFont, 'Segoe UI', Roboto, sans-serif;
            background: #F8F9FA; /* Light background */
            color: #212529; /* Dark text */
            line-height: 1.6;
            min-height: 100vh;
            font-weight: 400;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #2E86AB 0%, #A23B72 50%, #F18F01 100%); /* Vibrant gradient */
            color: white;
            padding: 1.5rem 0;
            text-align: center;
            box-shadow: 0 10px 40px rgba(46, 134, 171, 0.3); /* Soft shadow */
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            animation: pulse 4s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        h1, h2, h3 {
            color: #343A40;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        p {
            margin-bottom: 0.5rem;
        }

        /* Main Container */
        .container {
            max-width: 1000px;
            margin: 2rem auto;
            padding: 1.5rem;
            background: white;
            border-radius: 20px; /* More rounded corners */
            box-shadow: 0 8px 32px rgba(46, 134, 171, 0.1); /* Subtle shadow */
            flex-grow: 1; /* Allows container to grow and push footer down */
        }

        /* Controls Section (Horse Selector & Add Horse Button) */
        .controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap; /* Allows wrapping on smaller screens */
            align-items: center;
            position: sticky;
            top: 0;
            background: rgba(248, 249, 250, 0.95); /* Semi-transparent background */
            backdrop-filter: blur(10px); /* Blur effect */
            z-index: 10;
            padding: 1rem;
            border-radius: 20px;
            border: 2px solid rgba(46, 134, 171, 0.1);
            box-shadow: 0 8px 32px rgba(46, 134, 171, 0.1);
        }

        .horse-selector {
            flex: 1;
            min-width: 200px;
        }

        .horse-selector label {
            display: block;
            margin-bottom: 0.6rem;
            font-weight: 700;
            color: #2E86AB;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .horse-selector select {
            padding: 1rem 1.25rem;
            border: 3px solid rgba(46, 134, 171, 0.2);
            border-radius: 15px; /* Rounded select */
            font-size: 1rem;
            width: 100%;
            background: white;
            color: #212529;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(46, 134, 171, 0.1);
            -webkit-appearance: none; /* Remove default arrow */
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%232E86AB'%3E%3Cpath d='M7 10l5 5 5-5H7z'/%3E%3Csvg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1.2rem;
        }

        .horse-selector select:focus {
            outline: none;
            border-color: #2E86AB;
            box-shadow: 0 0 0 4px rgba(46, 134, 171, 0.2);
            transform: scale(1.01);
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 15px; /* Rounded buttons */
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            display: inline-flex; /* Use flex for icon and text alignment */
            align-items: center;
            justify-content: center;
            gap: 0.5rem; /* Space between icon and text */
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.6s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, #2E86AB, #1e5f7a);
            color: white;
            box-shadow: 0 6px 25px rgba(46, 134, 171, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 12px 40px rgba(46, 134, 171, 0.6);
        }

        .btn-success {
            background: linear-gradient(135deg, #28A745, #1e7e34);
            color: white;
            box-shadow: 0 6px 25px rgba(40, 167, 69, 0.4);
        }

        .btn-success:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 12px 40px rgba(40, 167, 69, 0.6);
        }

        .btn-danger {
            background: linear-gradient(135deg, #F18F01, #d17800);
            color: white;
            box-shadow: 0 6px 25px rgba(241, 143, 1, 0.4);
        }

        .btn-danger:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 12px 40px rgba(241, 143, 1, 0.6);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6C757D, #5a6268);
            color: white;
            box-shadow: 0 6px 25px rgba(108, 117, 125, 0.4);
        }

        .btn-secondary:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 12px 40px rgba(108, 117, 125, 0.6);
        }

        /* User ID Display */
        .user-id-display {
            background: #e6f7ff;
            border: 1px solid #91d5ff;
            padding: 0.75rem 1.25rem;
            border-radius: 15px;
            margin-bottom: 1.5rem;
            text-align: center;
            font-size: 0.9rem;
            color: #1890ff;
            font-weight: 600;
            word-break: break-all; /* Ensures long IDs wrap */
        }
        .user-id-display strong {
            color: #096dd9;
        }

        /* Upcoming Reminders */
        .upcoming-reminders {
            background: linear-gradient(135deg, rgba(241, 143, 1, 0.05) 0%, rgba(46, 134, 171, 0.05) 100%);
            border: 2px solid rgba(241, 143, 1, 0.2);
            padding: 1.5rem;
            border-radius: 20px;
            margin-bottom: 1.5rem;
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 20px rgba(241, 143, 1, 0.1);
        }

        .upcoming-reminders::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #F18F01, #2E86AB);
        }

        .upcoming-reminders h3 {
            color: #F18F01;
            margin-top: 0;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.2rem;
        }

        .reminder-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid rgba(241, 143, 1, 0.1);
            font-size: 1rem;
            font-weight: 500;
            color: #212529;
        }

        .reminder-item:last-child {
            border-bottom: none;
        }

        .reminder-item.overdue {
            background: linear-gradient(135deg, rgba(241, 143, 1, 0.15) 0%, rgba(162, 59, 114, 0.1) 100%);
            border-color: rgba(241, 143, 1, 0.3);
            animation: urgent 2s ease-in-out infinite;
            padding: 0.75rem; /* Adjust padding for overdue items */
            border-radius: 10px;
        }

        @keyframes urgent {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.01); }
        }

        /* Tab Navigation */
        .tab-container {
            display: flex;
            align-items: center;
            gap: 1rem;
            background: white;
            border-radius: 20px 20px 0 0;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(46, 134, 171, 0.15);
            border: 2px solid rgba(46, 134, 171, 0.1);
        }

        /* Desktop Tabs */
        .tabs {
            display: flex; /* Default to flex for desktop */
            flex: 1;
            background: white;
        }

        .tab {
            flex: 1;
            padding: 1.25rem;
            text-align: center;
            cursor: pointer;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 1rem;
            font-weight: 600;
            color: #6c757d;
            position: relative;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        .tab::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 4px;
            background: linear-gradient(90deg, #2E86AB, #A23B72);
            transition: all 0.3s ease;
            border-radius: 2px 2px 0 0;
        }

        .tab.active {
            background: linear-gradient(135deg, #2E86AB, #1e5f7a);
            color: white;
        }

        .tab.active::after {
            width: 100%;
            left: 0;
        }

        .tab:hover {
            background: linear-gradient(135deg, #e9ecef, #dee2e6);
            color: #212529;
            transform: translateY(-2px);
        }

        /* Mobile Tab Selector (hidden by default) */
        .mobile-tab-selector {
            display: none; /* Hidden by default, shown on mobile */
            flex-shrink: 0;
            padding: 0.5rem;
        }

        .mobile-tab-selector label {
            display: none; /* Hide label, select will be full width */
        }

        .mobile-tab-selector select {
            padding: 0.75rem;
            border: 3px solid rgba(46, 134, 171, 0.2);
            border-radius: 15px;
            font-size: 0.95rem;
            background: white;
            color: #212529;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(46, 134, 171, 0.1);
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%232E86AB'%3E%3Cpath d='M7 10l5 5 5-5H7z'/%3E%3Csvg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.2rem;
        }

        .mobile-tab-selector select:focus {
            outline: none;
            border-color: #2E86AB;
            box-shadow: 0 0 0 4px rgba(46, 134, 171, 0.2);
        }

        /* Tab Content Areas */
        .tab-content {
            background: white;
            padding: 2rem;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 10px 40px rgba(46, 134, 171, 0.15);
            max-height: 60vh; /* Max height for scrollable content */
            overflow-y: auto; /* Enable scrolling */
            -webkit-overflow-scrolling: touch;
            border: 2px solid rgba(46, 134, 171, 0.1);
            border-top: none; /* No top border as it connects to tabs */
            display: none; /* Hidden by default, shown by JS */
        }

        .tab-content.active {
            display: block; /* Show active tab content */
        }

        .add-record-btn {
            margin-bottom: 1.5rem;
            width: auto; /* Allow button to size naturally */
            min-width: 200px; /* Ensure it's not too small */
        }

        .record-list {
            display: flex;
            flex-direction: column;
            gap: 1.25rem; /* Space between record items */
        }

        .record-item {
            background: linear-gradient(135deg, rgba(46, 134, 171, 0.05) 0%, rgba(248, 249, 250, 0.8) 100%);
            padding: 1.5rem;
            border-radius: 20px;
            border: 2px solid rgba(46, 134, 171, 0.1);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .record-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(46, 134, 171, 0.15);
        }

        .record-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 6px;
            height: 100%;
            background: linear-gradient(180deg, #2E86AB, #A23B72);
            border-radius: 0 3px 3px 0;
        }

        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .record-type {
            font-weight: 800;
            color: #2E86AB;
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .record-date {
            color: #6c757d;
            font-size: 0.9rem;
            font-weight: 600;
            background: rgba(46, 134, 171, 0.1);
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
        }

        .record-details {
            color: #495057;
            margin-top: 0.75rem;
            font-size: 1rem;
            line-height: 1.6;
        }

        .record-details p {
            margin-bottom: 0.25rem;
        }

        .record-details p strong {
            color: #343A40;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
            font-size: 1.1rem;
            font-style: italic;
        }

        /* Modals */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(33, 37, 41, 0.7); /* Dark semi-transparent overlay */
            z-index: 1000; /* High z-index */
            backdrop-filter: blur(8px); /* Blur effect */
            display: flex; /* Use flexbox for centering */
            align-items: center; /* Center vertically */
            justify-content: center; /* Center horizontally */
            padding: 1rem; /* Padding for small screens */
        }

        .modal-content {
            background: linear-gradient(135deg, white 0%, rgba(248, 249, 250, 0.95) 100%);
            padding: 2.5rem;
            border-radius: 25px; /* More rounded */
            max-width: 550px; /* Slightly larger max-width */
            width: 95%; /* Responsive width */
            max-height: 90vh; /* Max height for scrollable modal content */
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            border: 2px solid rgba(46, 134, 171, 0.1);
            box-shadow: 0 25px 80px rgba(46, 134, 171, 0.2);
            position: relative;
            animation: modalFadeIn 0.3s ease-out;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-content h2 {
            color: #2E86AB;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 0; /* Override default h2 margin */
        }

        .close-button {
            font-size: 1.75rem;
            cursor: pointer;
            color: #6c757d;
            transition: all 0.3s ease;
            background: rgba(241, 143, 1, 0.1);
            padding: 0.5rem;
            border-radius: 50%;
        }

        .close-button:hover {
            color: #F18F01;
            background: rgba(241, 143, 1, 0.2);
            transform: scale(1.1);
        }

        /* Form Styling */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.6rem;
            font-weight: 700;
            color: #2E86AB;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="date"],
        .form-group input[type="time"],
        .form-group input[type="email"],
        .form-group input[type="password"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 1rem 1.25rem;
            border: 3px solid rgba(46, 134, 171, 0.2);
            border-radius: 15px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
            color: #212529;
            box-shadow: 0 4px 20px rgba(46, 134, 171, 0.1);
            z-index: 1; /* Ensure inputs are above other elements in stacking context if needed */
        }

        .form-group select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%232E86AB'%3E%3Cpath d='M7 10l5 5 5-5H7z'/%3E%3Csvg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1.2rem;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #2E86AB;
            box-shadow: 0 0 0 4px rgba(46, 134, 171, 0.2);
            transform: scale(1.01);
            z-index: 2; /* Bring focused input to front */
        }

        .form-row {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap; /* Allow wrapping */
        }

        .form-row .form-group {
            flex: 1;
            min-width: 150px; /* Ensures inputs have a minimum width */
            margin-bottom: 0; /* Remove extra margin when in a row */
        }

        .other-input {
            display: none; /* Hidden by default */
        }

        /* Footer Controls */
        .footer-controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 1rem;
            padding: 1rem;
            background: rgba(248, 249, 250, 0.95);
            backdrop-filter: blur(10px);
            border-top: 2px solid rgba(46, 134, 171, 0.1);
            box-shadow: 0 -8px 32px rgba(46, 134, 171, 0.1);
            z-index: 10;
            flex-wrap: wrap; /* Allow wrapping on small screens */
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 12px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(248, 249, 250, 0.8);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #2E86AB, #A23B72);
            border-radius: 10px;
            border: 2px solid rgba(248, 249, 250, 0.8);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #1e5f7a, #7a2c56);
        }

        /* Active Button Animation */
        .btn:active {
            animation: bounce 0.6s ease;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        /* Accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
                margin: 1rem auto 5rem auto; /* Adjust margin to account for fixed footer */
            }
            
            .form-row {
                flex-direction: column;
                gap: 1rem;
            }
            
            .controls {
                flex-wrap: wrap;
                align-items: stretch;
                gap: 0.75rem;
                padding: 0.75rem;
            }
            
            .horse-selector {
                flex: 1 1 100%;
                min-width: 0;
            }
            
            .btn-primary {
                flex: 1 1 auto;
                width: 100%;
            }
            
            .footer-controls {
                padding: 0.75rem;
                gap: 0.75rem;
            }
            
            /* Hide desktop tabs on mobile */
            .tabs {
                display: none;
            }
            
            /* Show mobile selector on mobile */
            .mobile-tab-selector {
                display: block;
            }

            .tab-container {
                flex-direction: row; /* Keep flex-direction for mobile selector and potential other elements */
                align-items: center;
                gap: 0.5rem;
            }

            .mobile-tab-selector select {
                width: 100%;
            }

            .tab-content {
                max-height: 50vh; /* Constrain height for scrolling on small screens */
                padding: 1.5rem;
            }

            .modal-content {
                margin: 2% auto;
                max-width: 95%;
                padding: 2rem;
            }

            .btn {
                padding: 0.75rem 1.25rem;
                font-size: 0.9rem;
            }

            .form-group select {
                padding: 1rem 2rem;
                background-size: 1.5rem;
                touch-action: manipulation; /* Improves responsiveness for selects */
            }

            /* Auth specific styles for mobile */
            .auth-section {
                padding: 1rem;
            }
        }

        @media (min-width: 769px) {
            /* Hide mobile selector on desktop */
            .mobile-tab-selector {
                display: none;
            }

            /* Ensure desktop tabs are visible */
            .tabs {
                display: flex; /* Explicitly show tabs on desktop */
            }
        }

        /* New Auth Specific Styles */
        .auth-section {
            background: white;
            padding: 2.5rem;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            margin: 2rem auto;
            text-align: center;
        }

        .auth-section h2 {
            color: #2E86AB;
            margin-bottom: 1.5rem;
        }

        .auth-section .form-group {
            margin-bottom: 1rem;
        }

        .auth-section .btn {
            margin-top: 1rem;
            width: 100%;
        }

        .auth-error {
            color: #e74c3c;
            margin-top: 1rem;
            font-weight: 600;
        }

        .google-sign-in-btn {
            background-color: #db4437;
            color: white;
            margin-top: 1.5rem;
        }
        .google-sign-in-btn:hover {
            background-color: #c23321;
        }

        .app-content {
            display: none; /* Hidden by default, shown after auth */
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script type="module">
        console.log("Script execution started."); // Added for debugging

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signInWithPopup,
            GoogleAuthProvider,
            onAuthStateChanged,
            signOut,
            signInWithCustomToken,
            signInAnonymously
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getDatabase, ref, push, set, remove, onValue, off, get } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // Global variables for Firebase instances and user ID
        let firebaseApp;
        let auth;
        let database;
        let horsesRef; // This will be set dynamically based on userId
        let userId = null; // Will store the current user's UID or anonymous ID

        // appId and initialAuthToken can stay global as they are environment variables or simple defaults
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let horses = {}; // Will store horses as an object with Firebase keys
        let selectedHorseKey = null; // Stores the Firebase key of the currently selected horse
        let unsubscribeHorsesListener = null; // To store the unsubscribe function for the Firebase listener

        // --- Utility Functions ---

        /**
         * Displays a custom message modal instead of a native alert.
         * @param {string} title - The title of the message.
         * @param {string} body - The body content of the message.
         */
        function showMessage(title, body) {
            console.log(`showMessage called: Title - "${title}", Body - "${body}"`); // Debug log
            const modalTitleElement = document.getElementById('messageModalTitle');
            const modalBodyElement = document.getElementById('messageModalBody');
            const finalBody = body && body.trim() !== '' ? body : 'An unknown error occurred or operation completed.'; // Ensure body is never empty

            if (modalTitleElement) {
                modalTitleElement.textContent = title;
            } else {
                console.error("messageModalTitle element not found for showMessage!");
            }

            if (modalBodyElement) {
                modalBodyElement.textContent = finalBody; // Use the guaranteed non-empty body
            } else {
                console.error("messageModalBody element not found for showMessage!");
            }
            
            openModal('messageModal');
        }

        /**
         * Displays a custom confirmation modal.
         * @param {string} title - The title of the confirmation.
         * @param {string} body - The body content of the confirmation.
         * @returns {Promise<boolean>} A promise that resolves to true if confirmed, false otherwise.
         */
        function showConfirm(title, body) {
            console.log(`showConfirm called: Title - "${title}", Body - "${body}"`); // Debug log
            return new Promise((resolve) => {
                const modalTitle = document.getElementById('confirmModalTitle');
                const modalBody = document.getElementById('confirmModalBody');
                const confirmOkBtn = document.getElementById('confirmOkBtn');
                const confirmCancelBtn = document.getElementById('confirmCancelBtn');

                if (!modalTitle || !modalBody || !confirmOkBtn || !confirmCancelBtn) {
                    console.error("Error: Confirmation modal elements not found!");
                    showMessage("Error", "Could not display confirmation dialog. Please check console for details.");
                    resolve(false);
                    return;
                }

                modalTitle.textContent = title;
                modalBody.textContent = body;
                openModal('confirmModal');

                const handleConfirm = () => {
                    closeModal('confirmModal');
                    confirmOkBtn.removeEventListener('click', handleConfirm);
                    confirmCancelBtn.removeEventListener('click', handleCancel);
                    resolve(true);
                };

                const handleCancel = () => {
                    closeModal('confirmModal');
                    confirmOkBtn.removeEventListener('click', handleConfirm);
                    confirmCancelBtn.removeEventListener('click', handleCancel);
                    resolve(false);
                };

                confirmOkBtn.removeEventListener('click', handleConfirm); // Prevent duplicate listeners
                confirmCancelBtn.removeEventListener('click', handleCancel); // Prevent duplicate listeners

                confirmOkBtn.addEventListener('click', handleConfirm);
                confirmCancelBtn.addEventListener('click', handleCancel);
            });
        }

        /**
         * Formats a date string to a localized string (e.g., DD/MM/YYYY for en-AU).
         * @param {string} dateString - The date string to format.
         * @returns {string} The formatted date string.
         */
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) {
                console.warn('Invalid date string provided to formatDate:', dateString);
                return 'Invalid Date';
            }
            const formattedDate = date.toLocaleDateString('en-AU', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
            return formattedDate;
        }

        /**
         * Capitalizes the first letter of a string.
         * @param {string} str - The input string.
         * @returns {string} The string with the first letter capitalized.
         */
        function capitalizeFirst(str) {
            if (!str) return '';
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        // --- Modal Functions ---

        /**
         * Opens a specified modal.
         * @param {string} modalId - The ID of the modal to open.
         */
        function openModal(modalId) {
            console.log(`Attempting to open modal: ${modalId}`); // Debug log
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'flex';
                if (modalId !== 'messageModal' && modalId !== 'confirmModal' && modalId !== 'authModal') {
                    const form = modal.querySelector('form');
                    if (form) {
                        form.reset();
                        const otherInputDivs = form.querySelectorAll('.other-input'); // Select all other-input divs
                        otherInputDivs.forEach(otherInputDiv => {
                            otherInputDiv.style.display = 'none';
                            const otherInputField = otherInputDiv.querySelector('input, textarea');
                            if (otherInputField) {
                                otherInputField.value = '';
                                otherInputField.removeAttribute('required');
                            }
                        });
                    }
                }
            } else {
                console.error(`Error: Modal ${modalId} not found for opening.`);
                // Fallback if showMessage itself fails to find the modal
                alert(`Error: Modal "${modalId}" not found. Check console for details.`);
            }
        }

        /**
         * Closes a specified modal.
         * @param {string} modalId - The ID of the modal to close.
         */
        function closeModal(modalId) {
            console.log(`Attempting to close modal: ${modalId}`); // Debug log
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
            } else {
                console.error(`Error: Modal ${modalId} not found for closing.`);
            }
        }

        // Expose functions to the global scope for inline HTML event handlers
        window.openModal = openModal;
        window.closeModal = closeModal;
        window.switchHorse = switchHorse;
        window.exportData = exportData;
        window.importData = importData;
        window.switchTab = switchTab;
        window.deleteRecord = deleteRecord;
        window.toggleOtherInput = toggleOtherInput; // Expose this too

        // Close modals when clicking outside of them
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    closeModal(modal.id); // Use the closeModal function
                }
            });
        };

        // --- "Other" Input Toggling ---

        /**
         * Toggles the visibility of an "Other" input field based on select dropdown value.
         * @param {Event} event - The change event from the select element.
         */
        function toggleOtherInput(event) {
            const selectElement = event.target;
            // Find the closest common ancestor that contains both the select and its associated other-input div
            const parentContainer = selectElement.closest('.form-group') || selectElement.closest('form'); 
            if (!parentContainer) {
                console.error('toggleOtherInput: Could not find a suitable parent container for the select element.');
                return;
            }
            
            // Find the specific 'other-input' div that is a sibling or within the same parent container
            let otherInputDiv = null;
            if (selectElement.id === 'vaccineType') {
                otherInputDiv = document.getElementById('otherVaccineInput');
            } else if (selectElement.id === 'dewormingProduct') {
                otherInputDiv = document.getElementById('otherDewormingInput');
            } else if (selectElement.id === 'farrierService') {
                otherInputDiv = document.getElementById('otherFarrierInput');
            } else if (selectElement.id === 'vetVisitType') {
                otherInputDiv = document.getElementById('otherVetInput');
            } else if (selectElement.id === 'feedType') {
                otherInputDiv = document.getElementById('otherFeedTypeInput');
            } else if (selectElement.id === 'trainingType') { // New for training
                otherInputDiv = document.getElementById('otherTrainingTypeInput');
            }

            if (otherInputDiv) {
                const otherInputField = otherInputDiv.querySelector('input, textarea');
                if (!otherInputField) {
                    console.error('toggleOtherInput: Other input field not found within the designated .other-input div.');
                    return;
                }

                if (selectElement.value === 'Other') {
                    otherInputDiv.style.display = 'block';
                    otherInputField.setAttribute('required', 'required');
                } else {
                    otherInputDiv.style.display = 'none';
                    otherInputField.removeAttribute('required');
                    otherInputField.value = '';
                }
            } else {
                console.warn(`toggleOtherInput: No specific 'other-input' div found for select ID: ${selectElement.id}`);
            }
        }


        // --- Firebase Data Listeners & Horse Management ---

        /**
         * Loads horses from Firebase into the select dropdown.
         * Uses an 'value' listener for real-time updates.
         */
        function loadHorses() {
            if (!userId || !database) {
                console.warn("User not authenticated or Firebase not initialized. Cannot load horses.");
                return;
            }

            // Unsubscribe from previous listener if exists
            if (unsubscribeHorsesListener) {
                off(horsesRef, 'value', unsubscribeHorsesListener);
                unsubscribeHorsesListener = null;
            }

            horsesRef = ref(database, `artifacts/${appId}/users/${userId}/horses`);
            
            const horseSelect = document.getElementById('horseSelect');
            horseSelect.innerHTML = '<option value="">-- Select a horse --</option>';

            unsubscribeHorsesListener = onValue(horsesRef, (snapshot) => {
                horses = snapshot.val() || {}; // Update the local 'horses' object
                horseSelect.innerHTML = '<option value="">-- Select a horse --</option>'; // Clear existing options

                let foundSelectedHorse = false;
                for (const key in horses) {
                    const horse = horses[key];
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = horse.name;
                    horseSelect.appendChild(option);
                    if (key === selectedHorseKey) {
                        foundSelectedHorse = true;
                    }
                }

                // Try to re-select the previously selected horse
                if (selectedHorseKey && foundSelectedHorse) {
                    horseSelect.value = selectedHorseKey;
                    loadHorseData();
                } else {
                    selectedHorseKey = null; // Reset if the horse was deleted or not found
                    document.getElementById('horseContent').style.display = 'none';
                    clearAllTabContent();
                }
                updateReminders();
            }, (errorObject) => {
                console.error("Firebase read failed: " + errorObject.code, errorObject);
                showMessage('Database Error', 'Failed to load horses from the database. Please check your connection and Firebase rules.');
            });
        }

        /**
         * Adds a new horse to Firebase.
         * @param {Event} e - The form submission event.
         */
        async function addHorse(e) {
            e.preventDefault();
            if (!userId || !horsesRef) {
                showMessage('Error', 'User not authenticated or Firebase not initialized. Cannot add horse.');
                return;
            }
            
            const name = document.getElementById('horseName').value.trim();
            if (!name) {
                showMessage('Input Required', 'Horse name is required.');
                return;
            }
            
            const breed = document.getElementById('horseBreed').value.trim();
            const age = document.getElementById('horseAge').value.trim();
            const colour = document.getElementById('horseColour').value.trim();
            
            const horseData = {
                name: name,
                breed: breed || 'Not specified',
                age: age || 'Not specified',
                colour: colour || 'Not specified',
                records: {
                    vaccinations: {},
                    deworming: {},
                    farrier: {},
                    veterinary: {},
                    feeding: {},
                    training: {} // Initialize training records
                }
            };
            
            try {
                const newHorseRef = push(horsesRef); // Generate a unique key
                await set(newHorseRef, horseData); // Set the horse data at that key
                selectedHorseKey = newHorseRef.key; // Set the newly added horse as selected
                // loadHorses() will be triggered by onValue listener
                closeModal('addHorseModal');
                document.getElementById('addHorseForm').reset();
                showMessage('Success', 'Horse added successfully!');
            } catch (error) {
                console.error("Error adding horse: ", error);
                showMessage('Error', `Failed to add horse: ${error.message}`);
            }
        }

        /**
         * Switches the currently selected horse in the UI based on Firebase key.
         */
        function switchHorse() {
            const horseSelect = document.getElementById('horseSelect');
            selectedHorseKey = horseSelect.value;
            
            if (!selectedHorseKey || !horses[selectedHorseKey]) {
                document.getElementById('horseContent').style.display = 'none';
                clearAllTabContent();
                return;
            }
            
            document.getElementById('horseContent').style.display = 'block';
            document.getElementById('tabSelect').value = 'overview'; // Default to overview
            switchTab('overview'); 
            loadHorseData(); // Load data for the newly selected horse
        }

        /**
         * Clears content from all record display tabs.
         */
        function clearAllTabContent() {
            document.getElementById('overviewContent').innerHTML = '<div class="empty-state">Please select a horse to view overview.</div>';
            document.getElementById('vaccinationRecords').innerHTML = '<div class="empty-state">No records yet. Click + Add to start.</div>';
            document.getElementById('dewormingRecords').innerHTML = '<div class="empty-state">No records yet. Click + Add to start.</div>';
            document.getElementById('farrierRecords').innerHTML = '<div class="empty-state">No records yet. Click + Add to start.</div>';
            document.getElementById('veterinaryRecords').innerHTML = '<div class="empty-state">No records yet. Click + Add to start.</div>';
            document.getElementById('feedingRecords').innerHTML = '<div class="empty-state">No records yet. Click + Add to start.</div>';
            document.getElementById('trainingRecords').innerHTML = '<div class="empty-state">No records yet. Click + Add to start.</div>'; // New for training
        }

        /**
         * Loads all data for the currently selected horse into the respective tab panes.
         * This function now relies on the `horses` object being updated by the Firebase listener.
         */
        function loadHorseData() {
            if (!selectedHorseKey) {
                console.warn("No horse selected. Cannot load horse data.");
                return;
            }
            const selectedHorse = horses[selectedHorseKey];
            
            loadOverview();
            loadRecords('vaccinations', 'vaccinationRecords');
            loadRecords('deworming', 'dewormingRecords');
            loadRecords('farrier', 'farrierRecords');
            loadRecords('veterinary', 'veterinaryRecords');
            loadRecords('feeding', 'feedingRecords');
            loadRecords('training', 'trainingRecords'); // New for training
        }

        /**
         * Populates the overview tab with horse details and recent activity.
         */
        function loadOverview() {
            if (!selectedHorseKey) {
                return;
            }
            const selectedHorse = horses[selectedHorseKey];
            const overviewContent = document.getElementById('overviewContent');
            
            let html = `
                <div class="record-item">
                    <h3>${selectedHorse.name || 'Unknown Horse'}</h3>
                    <p><strong>Breed:</strong> ${selectedHorse.breed || 'Not specified'}</p>
                    <p><strong>Age:</strong> ${selectedHorse.age || 'Not specified'}</p>
                    <p><strong>Colour:</strong> ${selectedHorse.colour || 'Not specified'}</p>
                </div>
            `;
            
            const allRecords = [];
            if (selectedHorse.records) {
                Object.keys(selectedHorse.records).forEach(type => {
                    const recordOfType = selectedHorse.records[type];
                    if (recordOfType) {
                        for (const recordKey in recordOfType) {
                            const record = recordOfType[recordKey];
                            allRecords.push({...record, type: type, firebaseKey: recordKey, date: record.date || ''}); // Ensure date exists
                        }
                    }
                });
            }
            
            allRecords.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (allRecords.length > 0) {
                html += '<h3>Recent Activity</h3>';
                allRecords.slice(0, 5).forEach(record => {
                    html += `
                        <div class="record-item">
                            <div class="record-header">
                                <span class="record-type">${capitalizeFirst(record.type)}</span>
                                <span class="record-date">${formatDate(record.date)}</span>
                            </div>
                            <div class="record-details">
                                ${getRecordSummary(record)}
                            </div>
                        </div>
                    `;
                });
            } else {
                html += '<div class="empty-state">No records yet. Add health records to start!</div>';
            }
            
            overviewContent.innerHTML = html;
        }

        /**
         * Populates a specific record tab (e.g., vaccinations, deworming).
         * @param {string} type - The type of record (e.g., 'vaccinations').
         * @param {string} containerId - The ID of the HTML container for these records.
         */
        function loadRecords(type, containerId) {
            if (!selectedHorseKey) {
                return;
            }
            const selectedHorse = horses[selectedHorseKey];
            const container = document.getElementById(containerId);
            const recordsObject = selectedHorse.records?.[type] || {};
            const records = Object.keys(recordsObject).map(key => ({ ...recordsObject[key], firebaseKey: key, date: recordsObject[key].date || '' }));
            
            if (records.length === 0) {
                container.innerHTML = '<div class="empty-state">No records yet. Click + Add to start.</div>';
                return;
            }
            
            const sortedRecords = records.sort((a, b) => new Date(b.date) - new Date(a.date));
            const fragment = document.createDocumentFragment();
            
            sortedRecords.forEach(record => {
                const recordDiv = document.createElement('div');
                recordDiv.className = 'record-item';
                recordDiv.innerHTML = `
                    <div class="record-header">
                        <span class="record-type">${getRecordTitle(record, type)}</span>
                        <div>
                            <span class="record-date">${formatDate(record.date)}</span>
                            <button class="btn btn-danger" onclick="deleteRecord('${type}', '${record.firebaseKey}')" aria-label="Delete this record">
                                <i class="fas fa-trash-alt"></i> Delete
                            </button>
                        </div>
                    </div>
                    <div class="record-details">
                        ${getRecordDetails(record, type)}
                    </div>
                `;
                fragment.appendChild(recordDiv);
            });
            
            container.innerHTML = '';
            container.appendChild(fragment);
        }

        /**
         * Gets a descriptive title for a record based on its type.
         * @param {object} record - The record object.
         * @param {string} type - The type of record.
         * @returns {string} The descriptive title.
         */
        function getRecordTitle(record, type) {
            switch(type) {
                case 'vaccinations':
                    return record.type || 'Vaccination';
                case 'deworming':
                    return record.product || 'Deworming';
                case 'farrier':
                    return record.service || 'Farrier Visit';
                case 'veterinary':
                    return record.visitType || 'Veterinary Visit';
                case 'feeding':
                    return `${record.feedType || 'Feed'} at ${record.time || 'N/A'}`;
                case 'training': // New case for training
                    return `${record.trainingType || 'Training'} Session`;
                default:
                    return 'Record';
            }
        }

        /**
         * Gets detailed HTML content for a record based on its type.
         * @param {object} record - The record object.
         * @param {string} type - The type of record.
         * @returns {string} HTML string with record details.
         */
        function getRecordDetails(record, type) {
            let details = '';
            
            switch(type) {
                case 'vaccinations':
                    if (record.veterinarian) details += `<p><strong>Veterinarian:</strong> ${record.veterinarian}</p>`;
                    if (record.nextDue) details += `<p><strong>Next Due:</strong> ${formatDate(record.nextDue)}</p>`;
                    if (record.notes) details += `<p><strong>Notes:</strong> ${record.notes}</p>`;
                    break;
                case 'deworming':
                    if (record.weight) details += `<p><strong>Weight:</strong> ${record.weight} kg</p>`;
                    if (record.nextDue) details += `<p><strong>Next Due:</strong> ${formatDate(record.nextDue)}</p>`;
                    if (record.notes) details += `<p><strong>Notes:</strong> ${record.notes}</p>`;
                    break;
                case 'farrier':
                    if (record.farrier) details += `<p><strong>Farrier:</strong> ${record.farrier}</p>`;
                    if (record.cost) details += `<p><strong>Cost:</strong> $${parseFloat(record.cost).toFixed(2)}</p>`;
                    if (record.nextDue) details += `<p><strong>Next Due:</strong> ${formatDate(record.nextDue)}</p>`;
                    if (record.notes) details += `<p><strong>Notes:</strong> ${record.notes}</p>`;
                    break;
                case 'veterinary':
                    if (record.veterinarian) details += `<p><strong>Veterinarian:</strong> ${record.veterinarian}</p>`;
                    if (record.diagnosis) details += `<p><strong>Diagnosis:</strong> ${record.diagnosis}</p>`;
                    if (record.treatment) details += `<p><strong>Treatment:</strong> ${record.treatment}</p>`;
                    if (record.cost) details += `<p><strong>Cost:</strong> $${parseFloat(record.cost).toFixed(2)}</p>`;
                    if (record.nextDue) details += `<p><strong>Next Check-up:</strong> ${formatDate(record.nextDue)}</p>`;
                    if (record.notes) details += `<p><strong>Notes:</strong> ${record.notes}</p>`;
                    break;
                case 'feeding':
                    if (record.portion) details += `<p><strong>Portion:</strong> ${record.portion}</p>`;
                    if (record.supplements) details += `<p><strong>Supplements:</strong> ${record.supplements}</p>`;
                    if (record.notes) details += `<p><strong>Notes:</strong> ${record.notes}</p>`;
                    break;
                case 'training': // New case for training
                    if (record.duration) details += `<p><strong>Duration:</strong> ${record.duration}</p>`;
                    if (record.notes) details += `<p><strong>Notes:</strong> ${record.notes}</p>`;
                    if (record.goals) details += `<p><strong>Goals:</strong> ${record.goals}</p>`;
                    break;
            }
            return details;
        }

        /**
         * Gets a summary string for a record, used in the overview tab.
         * @param {object} record - The record object.
         * @returns {string} A brief summary of the record.
         */
        function getRecordSummary(record) {
            switch(record.type) {
                case 'vaccinations':
                    return `${record.type || 'Vaccination'} administered`;
                case 'deworming':
                    return `${record.product || 'Deworming'} administered`;
                case 'farrier':
                    return `${record.service || 'Farrier visit'} by ${record.farrier || 'Farrier'}`;
                case 'veterinary':
                    return `${record.visitType || 'Veterinary visit'} by ${record.veterinarian || 'Veterinarian'}`;
                case 'feeding':
                    return `${record.feedType || 'Feed'} at ${record.time || 'N/A'}`;
                case 'training': // New case for training
                    return `${record.trainingType || 'Training'} session recorded`;
                default:
                    return 'Health record updated';
            }
        }

        /**
         * Deletes a specific record from the selected horse's data in Firebase.
         * @param {string} type - The type of record (e.g., 'vaccinations').
         * @param {string} recordKey - The Firebase key of the record to delete.
         */
        async function deleteRecord(type, recordKey) {
            if (!userId || !selectedHorseKey) {
                showMessage('Error', 'Please sign in and select a horse first.');
                return;
            }

            const confirmed = await showConfirm('Delete Record', 'Are you sure you want to delete this record? This action cannot be undone.');
            if (!confirmed) {
                return;
            }

            try {
                const recordPath = `artifacts/${appId}/users/${userId}/horses/${selectedHorseKey}/records/${type}/${recordKey}`;
                await remove(ref(database, recordPath));
                showMessage('Success', 'Record deleted successfully!');
                // Data will automatically reload via the Firebase listener in loadHorses()
            } catch (error) {
                console.error("Error deleting record: ", error);
                showMessage('Error', `Failed to delete record: ${error.message}`);
            }
        }

        // --- Add Record Functions (Firebase) ---

        /**
         * Adds a vaccination record to the selected horse in Firebase.
         * @param {Event} e - The form submission event.
         */
        async function addVaccination(e) {
            e.preventDefault();
            if (!userId || !selectedHorseKey) {
                showMessage('Error', 'Please sign in and select a horse first.');
                return;
            }
            
            const vaccineType = document.getElementById('vaccineType').value;
            const otherType = document.getElementById('otherVaccineType').value.trim();
            const date = document.getElementById('vaccineDate').value;
            const nextDue = document.getElementById('vaccineNextDue').value;
            const veterinarian = document.getElementById('vaccineVet').value.trim();
            const notes = document.getElementById('vaccineNotes').value.trim();
            
            const finalType = vaccineType === 'Other' ? otherType : vaccineType;

            if (!date || !finalType) {
                showMessage('Input Required', 'Date and Vaccine Type are required.');
                return;
            }
            
            const vaccinationData = {
                type: finalType,
                date: date,
                nextDue: nextDue,
                veterinarian: veterinarian,
                notes: notes
            };
            
            try {
                const newVaccinationRef = push(ref(database, `artifacts/${appId}/users/${userId}/horses/${selectedHorseKey}/records/vaccinations`));
                await set(newVaccinationRef, vaccinationData);
                closeModal('addVaccinationModal');
                document.getElementById('addVaccinationForm').reset();
                showMessage('Success', 'Vaccination added successfully!');
            } catch (error) {
                console.error("Error adding vaccination: ", error);
                showMessage('Error', `Failed to add vaccination: ${error.message}`);
            }
        }

        /**
         * Adds a deworming record to the selected horse in Firebase.
         * @param {Event} e - The form submission event.
         */
        async function addDeworming(e) {
            e.preventDefault();
            if (!userId || !selectedHorseKey) {
                showMessage('Error', 'Please sign in and select a horse first.');
                return;
            }
            
            const product = document.getElementById('dewormingProduct').value;
            const otherProduct = document.getElementById('otherDewormingProduct').value.trim();
            const date = document.getElementById('dewormingDate').value;
            const nextDue = document.getElementById('dewormingNextDue').value;
            const weight = document.getElementById('dewormingWeight').value;
            const notes = document.getElementById('dewormingNotes').value.trim();

            const finalProduct = product === 'Other' ? otherProduct : product;

            if (!date || !finalProduct) {
                showMessage('Input Required', 'Date and Deworming Product are required.');
                return;
            }
            
            const dewormingData = {
                product: finalProduct,
                date: date,
                nextDue: nextDue,
                weight: parseFloat(weight) || 0,
                notes: notes
            };
            
            try {
                const newDewormingRef = push(ref(database, `artifacts/${appId}/users/${userId}/horses/${selectedHorseKey}/records/deworming`));
                await set(newDewormingRef, dewormingData);
                closeModal('addDewormingModal');
                document.getElementById('addDewormingForm').reset();
                showMessage('Success', 'Deworming record added successfully!');
            } catch (error) {
                console.error("Error adding deworming record: ", error);
                showMessage('Error', `Failed to add deworming record: ${error.message}`);
            }
        }

        /**
         * Adds a farrier visit record to the selected horse in Firebase.
         * @param {Event} e - The form submission event.
         */
        async function addFarrier(e) {
            e.preventDefault();
            if (!userId || !selectedHorseKey) {
                showMessage('Error', 'Please sign in and select a horse first.');
                return;
            }
            
            const service = document.getElementById('farrierService').value;
            const otherService = document.getElementById('otherFarrierService').value.trim();
            const date = document.getElementById('farrierDate').value;
            const nextDue = document.getElementById('farrierNextDue').value;
            const farrier = document.getElementById('farrierName').value.trim();
            const cost = document.getElementById('farrierCost').value;
            const notes = document.getElementById('farrierNotes').value.trim();

            const finalService = service === 'Other' ? otherService : service;

            if (!date || !finalService) {
                showMessage('Input Required', 'Date and Service Type are required.');
                return;
            }
            
            const farrierVisitData = {
                service: finalService,
                date: date,
                nextDue: nextDue,
                farrier: farrier,
                cost: parseFloat(cost) || 0,
                notes: notes
            };
            
            try {
                const newFarrierRef = push(ref(database, `artifacts/${appId}/users/${userId}/horses/${selectedHorseKey}/records/farrier`));
                await set(newFarrierRef, farrierVisitData);
                closeModal('addFarrierModal');
                document.getElementById('addFarrierForm').reset();
                showMessage('Success', 'Farrier visit added successfully!');
            } catch (error) {
                console.error("Error adding farrier visit: ", error);
                showMessage('Error', `Failed to add farrier visit: ${error.message}`);
            }
        }

        /**
         * Adds a veterinary visit record to the selected horse in Firebase.
         * @param {Event} e - The form submission event.
         */
        async function addVeterinary(e) {
            e.preventDefault();
            console.log("addVeterinary function called."); // Added for debugging
            if (!userId || !selectedHorseKey) {
                showMessage('Error', 'Please sign in and select a horse first.');
                return;
            }
            
            try {
                const visitType = document.getElementById('vetVisitType').value;
                const otherVisitType = document.getElementById('otherVetVisitType').value.trim();
                const date = document.getElementById('vetDate').value;
                const nextDue = document.getElementById('vetNextDue').value;
                const veterinarian = document.getElementById('vetName').value.trim();
                const diagnosis = document.getElementById('vetDiagnosis').value.trim();
                const treatment = document.getElementById('vetTreatment').value.trim();
                const cost = document.getElementById('vetCost').value;
                const notes = document.getElementById('vetNotes').value.trim();

                const finalVisitType = visitType === 'Other' ? otherVisitType : visitType;

                if (!date || !finalVisitType) {
                    showMessage('Input Required', 'Date and Visit Type are required.');
                    return;
                }
                
                const veterinaryVisitData = {
                    visitType: finalVisitType,
                    date: date,
                    nextDue: nextDue,
                    veterinarian: veterinarian,
                    diagnosis: diagnosis,
                    treatment: treatment,
                    cost: parseFloat(cost) || 0,
                    notes: notes
                };
                
                const newVeterinaryRef = push(ref(database, `artifacts/${appId}/users/${userId}/horses/${selectedHorseKey}/records/veterinary`));
                await set(newVeterinaryRef, veterinaryVisitData);
                closeModal('addVeterinaryModal');
                document.getElementById('addVeterinaryForm').reset();
                showMessage('Success', 'Veterinary visit added successfully!');
            } catch (error) {
                console.error("Error in addVeterinary function: ", error);
                showMessage('Error', `Failed to add veterinary visit: ${error.message}. Check console for details.`);
            }
        }

        /**
         * Adds a feeding schedule record to the selected horse in Firebase.
         * @param {Event} e - The form submission event.
         */
        async function addFeedingSchedule(e) {
            e.preventDefault();
            if (!userId || !selectedHorseKey) {
                showMessage('Error', 'Please sign in and select a horse first.');
                return;
            }

            try {
                const date = document.getElementById('feedDate').value;
                const time = document.getElementById('feedTime').value;
                const feedType = document.getElementById('feedType').value;
                const otherFeedType = document.getElementById('otherFeedType').value.trim();
                const portion = document.getElementById('feedPortion').value.trim();
                const supplements = document.getElementById('feedSupplements').value.trim();
                const notes = document.getElementById('feedNotes').value.trim();

                const finalFeedType = feedType === 'Other' ? otherFeedType : feedType;

                if (!date || !time || !finalFeedType || !portion) {
                    showMessage('Input Required', 'Date, Time, Feed Type, and Portion are required.');
                    return;
                }

                const feedingData = {
                    date: date,
                    time: time,
                    feedType: finalFeedType,
                    portion: portion,
                    supplements: supplements,
                    notes: notes
                };

                const newFeedingRef = push(ref(database, `artifacts/${appId}/users/${userId}/horses/${selectedHorseKey}/records/feeding`));
                await set(newFeedingRef, feedingData);
                closeModal('addFeedingModal');
                document.getElementById('addFeedingForm').reset();
                showMessage('Success', 'Feeding schedule added successfully!');
            } catch (error) {
                console.error("Error in addFeedingSchedule function: ", error);
                showMessage('Error', `Failed to add feeding schedule: ${error.message}. Check console for details.`);
            }
        }

        /**
         * Adds a training session record to the selected horse in Firebase.
         * @param {Event} e - The form submission event.
         */
        async function addTrainingSession(e) {
            e.preventDefault();
            if (!userId || !selectedHorseKey) {
                showMessage('Error', 'Please sign in and select a horse first.');
                return;
            }

            try {
                const date = document.getElementById('trainingDate').value;
                const trainingType = document.getElementById('trainingType').value;
                const otherTrainingType = document.getElementById('otherTrainingType').value.trim();
                const duration = document.getElementById('trainingDuration').value.trim();
                const notes = document.getElementById('trainingNotes').value.trim();
                const goals = document.getElementById('trainingGoals').value.trim();

                const finalTrainingType = trainingType === 'Other' ? otherTrainingType : trainingType;

                if (!date || !finalTrainingType) {
                    showMessage('Input Required', 'Date and Training Type are required.');
                    return;
                }

                const trainingData = {
                    date: date,
                    trainingType: finalTrainingType,
                    duration: duration,
                    notes: notes,
                    goals: goals
                };

                const newTrainingRef = push(ref(database, `artifacts/${appId}/users/${userId}/horses/${selectedHorseKey}/records/training`));
                await set(newTrainingRef, trainingData);
                closeModal('addTrainingModal');
                document.getElementById('addTrainingForm').reset();
                showMessage('Success', 'Training session added successfully!');
            } catch (error) {
                console.error("Error in addTrainingSession function: ", error);
                showMessage('Error', `Failed to add training session: ${error.message}. Check console for details.`);
            }
        }


        // --- Reminder System ---

        /**
         * Updates and displays upcoming and overdue care reminders.
         */
        function updateReminders() {
            const remindersList = document.getElementById('remindersList');
            const upcomingRemindersDiv = document.getElementById('upcomingReminders');
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const upcomingDaysThreshold = 30;

            let allReminders = [];

            // Iterate through the `horses` object (which is populated by Firebase data)
            for (const horseKey in horses) {
                const horse = horses[horseKey];
                if (horse.records) {
                    Object.keys(horse.records).forEach(recordType => {
                        const recordsOfType = horse.records[recordType];
                        if (recordsOfType) { // Check if there are records for this type
                            for (const recordKey in recordsOfType) {
                                const record = recordsOfType[recordKey];
                                // Only add to reminders if it has a nextDue date
                                if (record.nextDue) {
                                    const dueDate = new Date(record.nextDue);
                                    dueDate.setHours(0, 0, 0, 0);

                                    const daysDiff = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));

                                    if (daysDiff <= upcomingDaysThreshold) {
                                        const typeMap = {
                                            'vaccinations': 'Vaccination',
                                            'deworming': 'Deworming',
                                            'farrier': 'Farrier',
                                            'veterinary': 'Vet Visit',
                                        };
                                        allReminders.push({
                                            horseName: horse.name,
                                            type: typeMap[recordType] || capitalizeFirst(recordType),
                                            item: getReminderItemName(record, recordType),
                                            dueDate: dueDate,
                                            daysDiff: daysDiff,
                                            overdue: daysDiff < 0
                                        });
                                    }
                                }
                            }
                        }
                    });
                }
            }

            allReminders.sort((a, b) => a.dueDate - b.dueDate);

            if (allReminders.length > 0) {
                remindersList.innerHTML = '';
                const fragment = document.createDocumentFragment();
                allReminders.forEach(reminder => {
                    const className = reminder.overdue ? 'reminder-item overdue' : 'reminder-item';
                    const statusText = reminder.overdue ?
                        `Overdue by ${Math.abs(reminder.daysDiff)} days` :
                        reminder.daysDiff === 0 ? 'Due today' : `Due in ${reminder.daysDiff} days`;

                    const reminderItem = document.createElement('div');
                    reminderItem.className = className;
                    reminderItem.innerHTML = `
                        <div>
                            <strong>${reminder.horseName}</strong> - ${reminder.item} (${reminder.type})
                        </div>
                        <div style="color: ${reminder.overdue ? '#DC3545' : '#007BFF'};">
                            ${statusText}
                        </div>
                    `;
                    fragment.appendChild(reminderItem);
                });
                remindersList.appendChild(fragment);
                upcomingRemindersDiv.style.display = 'block';
            } else {
                upcomingRemindersDiv.style.display = 'none';
                remindersList.innerHTML = '';
            }
        }

        /**
         * Gets the specific item name for a reminder (e.g., vaccine type, deworming product).
         * @param {object} record - The record object.
         * @param {string} type - The type of record.
         * @returns {string} The item name.
         */
        function getReminderItemName(record, type) {
            switch(type) {
                case 'vaccinations': return record.type;
                case 'deworming': return record.product;
                case 'farrier': return record.service;
                case 'veterinary': return record.visitType;
                default: return '';
            }
        }

        // --- Tab Switching Logic ---

        /**
         * Switches the active tab and loads content for it.
         * @param {string} tabId - The ID of the tab to activate (e.g., 'overview', 'vaccinations').
         */
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(pane => {
                pane.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            const selectedPane = document.getElementById(`${tabId}Content`);
            if (selectedPane) {
                selectedPane.classList.add('active');
            } else {
                console.error(`Tab content for ID "${tabId}Content" not found.`);
            }
            
            const selectedTabButton = document.querySelector(`.tab[data-tab="${tabId}"]`);
            if (selectedTabButton) {
                selectedTabButton.classList.add('active');
            }

            const mobileTabSelect = document.getElementById('tabSelect');
            if (mobileTabSelect) {
                mobileTabSelect.value = tabId;
            }

            if (selectedHorseKey) {
                loadHorseData();
            } else {
                clearAllTabContent();
            }
        }

        // --- Data Import/Export (now interacts with Firebase) ---

        /**
         * Exports all horse data from Firebase to a JSON file.
         */
        async function exportData() {
            if (!userId) {
                showMessage('Error', 'Please sign in to export data.');
                return;
            }
            try {
                const snapshot = await get(ref(database, `artifacts/${appId}/users/${userId}/horses`));
                const data = snapshot.val();
                if (data) {
                    const dataStr = JSON.stringify(data, null, 2);
                    const dataBlob = new Blob([dataStr], {type: 'application/json'});
                    const url = URL.createObjectURL(dataBlob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `horse_health_data_${userId}.json`;
                    link.click();
                    URL.revokeObjectURL(url);
                    showMessage('Export Complete', `Your horse data has been exported as "horse_health_data_${userId}.json".`);
                } else {
                    showMessage('No Data', 'No horse data found to export.');
                }
            } catch (error) {
                console.error("Error exporting data: ", error);
                showMessage('Error', `Failed to export data: ${error.message}`);
            }
        }

        /**
         * Triggers the hidden file input to open the import dialog.
         */
        function importData() {
            document.getElementById('importFile').click();
        }

        /**
         * Handles the file selection for importing data to Firebase.
         * @param {Event} event - The change event from the file input.
         */
        async function handleImport(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (typeof importedData === 'object' && importedData !== null) {
                        const confirmed = await showConfirm('Import Data', 'Importing will REPLACE ALL existing horse data for your account. Are you sure?');
                        if (!confirmed) {
                            return;
                        }
                        if (!userId) {
                            showMessage('Error', 'Please sign in to import data.');
                            return;
                        }
                        await set(ref(database, `artifacts/${appId}/users/${userId}/horses`), importedData); // Overwrite all data for the user
                        showMessage('Import Complete', 'Data imported successfully!');
                        // Data will automatically reload via the Firebase listener
                    } else {
                        showMessage('Invalid File', 'Invalid file format. Please select a valid JSON object file.');
                    }
                } catch (error) {
                    console.error("Error reading or importing file: ", error);
                    showMessage('Error', `Error reading file. Please make sure it's a valid JSON file. Details: ${error.message}`);
                }
            };
            reader.readAsText(file);
        }

        // --- Firebase Authentication Logic ---

        const authSection = document.getElementById('authSection');
        const appContent = document.getElementById('appContent');
        const authEmailInput = document.getElementById('authEmail');
        const authPasswordInput = document.getElementById('authPassword');
        const authErrorDisplay = document.getElementById('authError');
        const userUidDisplay = document.getElementById('userUidDisplay');
        const signOutButton = document.getElementById('signOutButton');

        // --- Initialization ---

        document.addEventListener('DOMContentLoaded', async function() {
            console.log('DOM Content Loaded. Initializing app...');

            // Firebase configuration - ALWAYS use the hardcoded values for debugging purposes
            const firebaseConfig = {
                apiKey: "AIzaSyDrsPDMYMYY32S_G26MzwNBL1EIlieCJ0s",
                authDomain: "horse-health-tracker.firebaseapp.com",
                databaseURL: "https://horse-health-tracker-default-rtdb.firebaseio.com",
                projectId: "horse-health-tracker",
                storageBucket: "horse-health-tracker.firebasestorage.app",
                messagingSenderId: "870591273427",
                appId: "1:870591273427:web:8d28da42ac9a53f5783726"
            };
            console.log("Firebase config being used:", firebaseConfig); // Log the config being used

            try {
                firebaseApp = initializeApp(firebaseConfig);
                auth = getAuth(firebaseApp);
                database = getDatabase(firebaseApp);
                console.log("Firebase initialized successfully. App:", firebaseApp, "Auth:", auth, "Database:", database); // Log initialized objects

                // Auth State Observer
                onAuthStateChanged(auth, (user) => {
                    console.log("onAuthStateChanged triggered. User:", user ? user.uid : "null");
                    if (user) {
                        userId = user.uid;
                        if (authSection) authSection.style.display = 'none';
                        if (appContent) appContent.style.display = 'block';
                        if (userUidDisplay) userUidDisplay.textContent = `Your User ID: ${userId}`;
                        loadHorses();
                        switchTab('overview');
                    } else {
                        userId = null;
                        if (authSection) authSection.style.display = 'block';
                        if (appContent) appContent.style.display = 'none';
                        if (userUidDisplay) userUidDisplay.textContent = '';
                        horses = {};
                        selectedHorseKey = null;
                        clearAllTabContent();
                        if (unsubscribeHorsesListener) {
                            off(horsesRef, 'value', unsubscribeHorsesListener);
                            unsubscribeHorsesListener = null;
                        }
                    }
                });

                // Initial authentication check for Canvas environment
                if (initialAuthToken) {
                    try {
                        console.log("Attempting to sign in with custom token...");
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Signed in with custom token provided by Canvas environment.");
                    } catch (error) {
                        console.error("Error signing in with custom token:", error);
                        try {
                            console.log("Falling back to anonymous sign-in...");
                            await signInAnonymously(auth);
                            console.log("Signed in anonymously as fallback.");
                        } catch (anonError) {
                            console.error("Error signing in anonymously:", anonError);
                            showMessage('Authentication Error', `Failed to sign in anonymously: ${anonError.message}`);
                        }
                    }
                } else {
                    try {
                        console.log("Attempting anonymous sign-in as no custom token was provided...");
                        await signInAnonymously(auth);
                        console.log("Signed in anonymously as no custom token was provided.");
                    } catch (anonError) {
                        console.error("Error signing in anonymously:", anonError);
                        showMessage('Authentication Error', `Failed to sign in anonymously: ${anonError.message}`);
                    }
                }

            } catch (error) {
                console.error("Firebase initialization or initial sign-in failed:", error);
                showMessage('Firebase Initialization Error', `Failed to initialize Firebase. Please ensure your Firebase configuration is correct and valid JSON. Error: ${error.message}`);
                return;
            }

            // Helper function for authentication actions
            const handleAuthAction = async (actionFn, successMsg, errorMsg) => {
                if (!auth) {
                    showMessage('Authentication Error', 'Firebase Auth is not initialized. Please refresh the page or check console for configuration errors.');
                    return;
                }
                const email = authEmailInput.value;
                const password = authPasswordInput.value;
                if (!email || !password) {
                    showMessage('Input Required', 'Email and password are required.');
                    return;
                }
                if (authErrorDisplay) authErrorDisplay.textContent = '';
                try {
                    await actionFn(auth, email, password);
                    showMessage('Success', successMsg);
                } catch (error) {
                    if (authErrorDisplay) authErrorDisplay.textContent = `Error: ${error.message}`;
                    console.error(errorMsg, error);
                }
            };

            // Attach form submission listeners
            document.getElementById('addHorseForm').addEventListener('submit', addHorse);
            document.getElementById('addVaccinationForm').addEventListener('submit', addVaccination);
            document.getElementById('addDewormingForm').addEventListener('submit', addDeworming);
            document.getElementById('addFarrierForm').addEventListener('submit', addFarrier);
            document.getElementById('addVeterinaryForm').addEventListener('submit', addVeterinary);
            document.getElementById('addFeedingForm').addEventListener('submit', addFeedingSchedule);
            document.getElementById('addTrainingForm').addEventListener('submit', addTrainingSession); // New for training
            
            // Attach change listeners for "Other" input toggling
            document.getElementById('vaccineType').addEventListener('change', toggleOtherInput);
            document.getElementById('dewormingProduct').addEventListener('change', toggleOtherInput);
            document.getElementById('farrierService').addEventListener('change', toggleOtherInput);
            document.getElementById('vetVisitType').addEventListener('change', toggleOtherInput);
            document.getElementById('feedType').addEventListener('change', toggleOtherInput);
            document.getElementById('trainingType').addEventListener('change', toggleOtherInput); // New for training

            // Attach import file listener
            document.getElementById('importFile').addEventListener('change', handleImport);

            // Ensure no service modals are open on load by explicitly closing them
            closeModal('addHorseModal');
            closeModal('addVaccinationModal');
            closeModal('addDewormingModal');
            closeModal('addFarrierModal');
            closeModal('addVeterinaryModal');
            closeModal('addFeedingModal');
            closeModal('addTrainingModal'); // New for training
            closeModal('messageModal');
            closeModal('confirmModal');

            // Set the initial tab to overview (will be re-set by onAuthStateChanged)
            switchTab('overview');

            // Attach Firebase authentication button listeners
            const signUpBtn = document.getElementById('signUpBtn');
            const signInBtn = document.getElementById('signInBtn');
            const googleSignInBtn = document.getElementById('googleSignInBtn');
            const signOutButtonElement = document.getElementById('signOutButton');

            if (signUpBtn) {
                signUpBtn.addEventListener('click', () => handleAuthAction(createUserWithEmailAndPassword, 'Account created and signed in!', 'Sign Up Error:'));
            }

            if (signInBtn) {
                signInBtn.addEventListener('click', () => handleAuthAction(signInWithEmailAndPassword, 'Signed in successfully!', 'Sign In Error:'));
            }

            if (googleSignInBtn) {
                googleSignInBtn.addEventListener('click', async () => {
                    if (!auth) {
                        showMessage('Authentication Error', 'Firebase Auth is not initialized. Please refresh the page or check console for configuration errors.');
                        return;
                    }
                    const provider = new GoogleAuthProvider();
                    if (authErrorDisplay) authErrorDisplay.textContent = '';
                    try {
                        await signInWithPopup(auth, provider);
                        showMessage('Success', 'Signed in with Google!');
                    } catch (error) {
                        if (authErrorDisplay) authErrorDisplay.textContent = `Error: ${error.message}`;
                        console.error("Google Sign-In Error:", error);
                    }
                });
            }

            if (signOutButtonElement) {
                signOutButtonElement.addEventListener('click', async () => {
                    try {
                        await signOut(auth);
                        showMessage('Signed Out', 'You have been signed out.');
                    } catch (error) {
                        showMessage('Error', `Failed to sign out: ${error.message}`);
                        console.error("Sign Out Error:", error);
                    }
                });
            }
        });

    </script>
</head>
<body>
    <div class="header">
        <h1>🐴 Horse Health Tracker</h1>
        <p>Track your horses' health records and care</p>
    </div>

    <div id="authSection" class="auth-section">
        <h2>Sign In / Sign Up</h2>
        <div class="form-group">
            <label for="authEmail">Email:</label>
            <input type="email" id="authEmail" required>
        </div>
        <div class="form-group">
            <label for="authPassword">Password:</label>
            <input type="password" id="authPassword" required>
        </div>
        <button id="signInBtn" class="btn btn-primary">Sign In</button>
        <button id="signUpBtn" class="btn btn-secondary">Sign Up</button>
        <p id="authError" class="auth-error"></p>
        <div style="margin: 1.5rem 0; border-top: 1px solid #eee;"></div>
        <button id="googleSignInBtn" class="btn google-sign-in-btn">
            <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12.0001 4.58603C14.1201 4.58603 15.9801 5.36603 17.3401 6.72603L20.0501 4.01603C18.0001 1.96603 15.2301 0.726031 12.0001 0.726031C7.72012 0.726031 4.07012 3.25603 2.37012 6.78603L5.61012 9.31603C6.46012 6.59603 8.99012 4.58603 12.0001 4.58603Z" fill="#EA4335"/>
                <path d="M23.27 12.028C23.27 11.108 23.18 10.338 23.05 9.59803H12V14.288H18.72C18.43 15.848 17.57 17.188 16.31 18.088L19.56 20.598C21.49 18.848 22.69 16.308 23.27 12.028Z" fill="#4285F4"/>
                <path d="M5.61006 14.718L2.36006 17.248C3.23006 19.008 4.58006 20.448 6.16006 21.468L9.31006 18.938C8.45006 16.218 6.46006 14.208 5.61006 14.718Z" fill="#FBBC05"/>
                <path d="M12.0001 23.278C15.2301 23.278 18.0001 22.038 20.0501 19.988L17.3401 17.278C15.9801 18.638 14.1201 19.418 12.0001 19.418C8.99012 19.418 6.46012 17.408 5.61012 14.718L2.37012 17.248C4.07012 20.778 7.72012 23.278 12.0001 23.278Z" fill="#34A853"/>
            </svg>
            Sign in with Google
        </button>
    </div>

    <div id="appContent" class="container">
        <div class="user-id-display">
            <span id="userUidDisplay"></span>
            <button id="signOutButton" class="btn btn-secondary" style="margin-left: 1rem;">Sign Out</button>
        </div>

        <div class="controls">
            <div class="horse-selector">
                <label for="horseSelect">Select Horse:</label>
                <select id="horseSelect" onchange="switchHorse()" aria-label="Select a horse">
                    <option value="">-- Select a horse --</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="openModal('addHorseModal')" aria-label="Add new horse">+ Add Horse</button>
        </div>

        <div id="upcomingReminders" class="upcoming-reminders" style="display: none;">
            <h3>🔔 Upcoming & Overdue Care</h3>
            <div id="remindersList"></div>
        </div>

        <div id="horseContent" style="display: none;">
            <div class="tab-container">
                <div class="tabs">
                    <button class="tab active" data-tab="overview" onclick="switchTab('overview')" aria-label="View health overview">Overview</button>
                    <button class="tab" data-tab="vaccinations" onclick="switchTab('vaccinations')" aria-label="View vaccination records">Vaccinations</button>
                    <button class="tab" data-tab="deworming" onclick="switchTab('deworming')" aria-label="View deworming records">Deworming</button>
                    <button class="tab" data-tab="farrier" onclick="switchTab('farrier')" aria-label="View farrier records">Farrier</button>
                    <button class="tab" data-tab="veterinary" onclick="switchTab('veterinary')" aria-label="View veterinary records">Veterinary</button>
                    <button class="tab" data-tab="feeding" onclick="switchTab('feeding')" aria-label="View feeding schedules">Feeding</button>
                    <button class="tab" data-tab="training" onclick="switchTab('training')" aria-label="View training log">Training</button> <!-- NEW TAB -->
                </div>
                <div class="mobile-tab-selector">
                    <label for="tabSelect" class="sr-only">Select Tab</label>
                    <select id="tabSelect" onchange="switchTab(this.value)" aria-label="Select a health record category">
                        <option value="overview">Overview</option>
                        <option value="vaccinations">Vaccinations</option>
                        <option value="deworming">Deworming</option>
                        <option value="farrier">Farrier</option>
                        <option value="veterinary">Veterinary</option>
                        <option value="feeding">Feeding</option>
                        <option value="training">Training</option> <!-- NEW OPTION -->
                    </select>
                </div>
            </div>

            <div id="overviewContent" class="tab-content active">
                </div>
            <div id="vaccinationsContent" class="tab-content">
                <button class="btn btn-success add-record-btn" onclick="openModal('addVaccinationModal')" aria-label="Add new vaccination record">
                    <i class="fas fa-plus"></i> Add Vaccination
                </button>
                <div id="vaccinationRecords" class="record-list">
                    </div>
            </div>
            <div id="dewormingContent" class="tab-content">
                <button class="btn btn-success add-record-btn" onclick="openModal('addDewormingModal')" aria-label="Add new deworming record">
                    <i class="fas fa-plus"></i> Add Deworming
                </button>
                <div id="dewormingRecords" class="record-list">
                    </div>
            </div>
            <div id="farrierContent" class="tab-content">
                <button class="btn btn-success add-record-btn" onclick="openModal('addFarrierModal')" aria-label="Add new farrier visit record">
                    <i class="fas fa-plus"></i> Add Farrier Visit
                </button>
                <div id="farrierRecords" class="record-list">
                    </div>
            </div>
            <div id="veterinaryContent" class="tab-content">
                <button class="btn btn-success add-record-btn" onclick="openModal('addVeterinaryModal')" aria-label="Add new veterinary visit record">
                    <i class="fas fa-plus"></i> Add Veterinary Visit
                </button>
                <div id="veterinaryRecords" class="record-list">
                    </div>
            </div>
            <div id="feedingContent" class="tab-content">
                <button class="btn btn-success add-record-btn" onclick="openModal('addFeedingModal')" aria-label="Add new feeding schedule">
                    <i class="fas fa-plus"></i> Add Feed Schedule
                </button>
                <div id="feedingRecords" class="record-list">
                </div>
            </div>
            <div id="trainingContent" class="tab-content"> <!-- NEW TRAINING TAB CONTENT -->
                <button class="btn btn-success add-record-btn" onclick="openModal('addTrainingModal')" aria-label="Add new training session">
                    <i class="fas fa-plus"></i> Add Training Session
                </button>
                <div id="trainingRecords" class="record-list">
                </div>
            </div>
        </div>
    </div>

    <div class="footer-controls">
        <button class="btn btn-secondary" onclick="exportData()" aria-label="Export all horse data">
            <i class="fas fa-download"></i> Export Data
        </button>
        <button class="btn btn-secondary" onclick="importData()" aria-label="Import horse data from file">
            <i class="fas fa-upload"></i> Import Data
        </button>
        <input type="file" id="importFile" accept=".json" style="display: none;">
    </div>

    <div id="addHorseModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('addHorseModal')" aria-label="Close add horse dialog">&times;</span>
            <h2>Add New Horse</h2>
            <form id="addHorseForm">
                <div class="form-group">
                    <label for="horseName">Horse Name:</label>
                    <input type="text" id="horseName" required aria-required="true">
                </div>
                <div class="form-group">
                    <label for="horseBreed">Breed:</label>
                    <input type="text" id="horseBreed">
                </div>
                <div class="form-group">
                    <label for="horseAge">Age:</label>
                    <input type="text" id="horseAge" placeholder="e.g., 5 years, 3 months">
                </div>
                <div class="form-group">
                    <label for="horseColour">Colour:</label>
                    <input type="text" id="horseColour">
                </div>
                <button type="submit" class="btn btn-primary" aria-label="Submit new horse">Add Horse</button>
            </form>
        </div>
    </div>

    <div id="addVaccinationModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('addVaccinationModal')" aria-label="Close add vaccination dialog">&times;</span>
            <h2>Add Vaccination Record</h2>
            <form id="addVaccinationForm">
                <div class="form-group">
                    <label for="vaccineType">Vaccine Type:</label>
                    <select id="vaccineType" required onchange="toggleOtherInput(event)" aria-required="true">
                        <option value="">-- Select Type --</option>
                        <option value="Tetanus">Tetanus</option>
                        <option value="Strangles">Strangles</option>
                        <option value="Equine Influenza">Equine Influenza</option>
                        <option value="Hendra Virus">Hendra Virus</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group other-input" id="otherVaccineInput" style="display:none;">
                    <label for="otherVaccineType">Specify Other Vaccine Type:</label>
                    <input type="text" id="otherVaccineType">
                </div>
                <div class="form-group">
                    <label for="vaccineDate">Date Administered:</label>
                    <input type="date" id="vaccineDate" required aria-required="true">
                </div>
                <div class="form-group">
                    <label for="vaccineNextDue">Next Due Date:</label>
                    <input type="date" id="vaccineNextDue">
                </div>
                <div class="form-group">
                    <label for="vaccineVet">Veterinarian:</label>
                    <input type="text" id="vaccineVet">
                </div>
                <div class="form-group">
                    <label for="vaccineNotes">Notes:</label>
                    <textarea id="vaccineNotes" rows="2"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" aria-label="Submit new vaccination record">Add Vaccination</button>
            </form>
        </div>
    </div>

    <div id="addDewormingModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('addDewormingModal')" aria-label="Close add deworming dialog">&times;</span>
            <h2>Add Deworming Record</h2>
            <form id="addDewormingForm">
                <div class="form-group">
                    <label for="dewormingProduct">Deworming Product:</label>
                    <select id="dewormingProduct" required onchange="toggleOtherInput(event)" aria-required="true">
                        <option value="">-- Select Product --</option>
                        <option value="Ivermectin">Ivermectin</option>
                        <option value="Moxidectin">Moxidectin</option>
                        <option value="Fenbendazole">Fenbendazole</option>
                        <option value="Pyrantel">Pyrantel</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group other-input" id="otherDewormingInput" style="display:none;">
                    <label for="otherDewormingProduct">Specify Other Product:</label>
                    <input type="text" id="otherDewormingProduct">
                </div>
                <div class="form-group">
                    <label for="dewormingDate">Date Administered:</label>
                    <input type="date" id="dewormingDate" required aria-required="true">
                </div>
                <div class="form-group">
                    <label for="dewormingNextDue">Next Due Date:</label>
                    <input type="date" id="dewormingNextDue">
                </div>
                <div class="form-group">
                    <label for="dewormingWeight">Estimated Weight (kg):</label>
                    <input type="number" id="dewormingWeight" min="0" step="0.01">
                </div>
                <div class="form-group">
                    <label for="dewormingNotes">Notes:</label>
                    <textarea id="dewormingNotes" rows="2"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" aria-label="Submit new deworming record">Add Deworming</button>
            </form>
        </div>
    </div>

    <div id="addFarrierModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('addFarrierModal')" aria-label="Close add farrier dialog">&times;</span>
            <h2>Add Farrier Visit Record</h2>
            <form id="addFarrierForm">
                <div class="form-group">
                    <label for="farrierService">Service Type:</label>
                    <select id="farrierService" required onchange="toggleOtherInput(event)" aria-required="true">
                        <option value="">-- Select Service --</option>
                        <option value="Trim">Trim</option>
                        <option value="Front Shoes">Front Shoes</option>
                        <option value="Full Set Shoes">Full Set Shoes</option>
                        <option value="Corrective Shoeing">Corrective Shoeing</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group other-input" id="otherFarrierInput" style="display:none;">
                    <label for="otherFarrierService">Specify Other Service:</label>
                    <input type="text" id="otherFarrierService">
                </div>
                <div class="form-group">
                    <label for="farrierDate">Date of Visit:</label>
                    <input type="date" id="farrierDate" required aria-required="true">
                </div>
                <div class="form-group">
                    <label for="farrierNextDue">Next Due Date:</label>
                    <input type="date" id="farrierNextDue">
                </div>
                <div class="form-group">
                    <label for="farrierName">Farrier Name:</label>
                    <input type="text" id="farrierName">
                </div>
                <div class="form-group">
                    <label for="farrierCost">Cost ($):</label>
                    <input type="number" id="farrierCost" min="0" step="0.01">
                </div>
                <div class="form-group">
                    <label for="farrierNotes">Notes:</label>
                    <textarea id="farrierNotes" rows="2"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" aria-label="Submit new farrier visit">Add Farrier Visit</button>
            </form>
        </div>
    </div>

    <div id="addVeterinaryModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('addVeterinaryModal')" aria-label="Close add veterinary dialog">&times;</span>
            <h2>Add Veterinary Visit Record</h2>
            <form id="addVeterinaryForm">
                <div class="form-group">
                    <label for="vetVisitType">Visit Type:</label>
                    <select id="vetVisitType" required onchange="toggleOtherInput(event)" aria-required="true">
                        <option value="">-- Select Type --</option>
                        <option value="Routine Check-up">Routine Check-up</option>
                        <option value="Emergency">Emergency</option>
                        <option value="Dental">Dental</option>
                        <option value="Lameness Exam">Lameness Exam</option>
                        <option value="Pre-purchase Exam">Pre-purchase Exam</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group other-input" id="otherVetInput" style="display:none;">
                    <label for="otherVetVisitType">Specify Other Visit Type:</label>
                    <input type="text" id="otherVetVisitType">
                </div>
                <div class="form-group">
                    <label for="vetDate">Date of Visit:</label>
                    <input type="date" id="vetDate" required aria-required="true">
                </div>
                <div class="form-group">
                    <label for="vetNextDue">Next Check-up Due:</label>
                    <input type="date" id="vetNextDue">
                </div>
                <div class="form-group">
                    <label for="vetName">Veterinarian:</label>
                    <input type="text" id="vetName">
                </div>
                <div class="form-group">
                    <label for="vetDiagnosis">Diagnosis/Findings:</label>
                    <textarea id="vetDiagnosis" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label for="vetTreatment">Treatment:</label>
                    <textarea id="vetTreatment" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label for="vetCost">Cost ($):</label>
                    <input type="number" id="vetCost" min="0" step="0.01">
                </div>
                <div class="form-group">
                    <label for="vetNotes">Notes:</label>
                    <textarea id="vetNotes" rows="2"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" aria-label="Submit new veterinary visit">Add Veterinary Visit</button>
            </form>
        </div>
    </div>

    <div id="addFeedingModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('addFeedingModal')" aria-label="Close add feeding schedule dialog">&times;</span>
            <h2>Add Feeding Schedule</h2>
            <form id="addFeedingForm">
                <div class="form-group">
                    <label for="feedDate">Date:</label>
                    <input type="date" id="feedDate" required aria-required="true">
                </div>
                <div class="form-group">
                    <label for="feedTime">Time:</label>
                    <input type="time" id="feedTime" required aria-required="true">
                </div>
                <div class="form-group">
                    <label for="feedType">Feed Type:</label>
                    <select id="feedType" required onchange="toggleOtherInput(event)" aria-required="true">
                        <option value="">-- Select Feed Type --</option>
                        <option value="Hay">Hay</option>
                        <option value="Grain">Grain</option>
                        <option value="Pellets">Pellets</option>
                        <option value="Chaff">Chaff</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group other-input" id="otherFeedTypeInput" style="display:none;">
                    <label for="otherFeedType">Specify Other Feed Type:</label>
                    <input type="text" id="otherFeedType">
                </div>
                <div class="form-group">
                    <label for="feedPortion">Portion:</label>
                    <input type="text" id="feedPortion" placeholder="e.g., 2 flakes, 1kg, 2 scoops" required aria-required="true">
                </div>
                <div class="form-group">
                    <label for="feedSupplements">Supplements:</label>
                    <textarea id="feedSupplements" rows="2" placeholder="e.g., Biotin, Joint Supplement"></textarea>
                </div>
                <div class="form-group">
                    <label for="feedNotes">Notes:</label>
                    <textarea id="feedNotes" rows="2"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" aria-label="Submit new feeding schedule">Add Feed Schedule</button>
            </form>
        </div>
    </div>

    <div id="addTrainingModal" class="modal"> <!-- NEW TRAINING MODAL -->
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('addTrainingModal')" aria-label="Close add training session dialog">&times;</span>
            <h2>Add Training Session</h2>
            <form id="addTrainingForm">
                <div class="form-group">
                    <label for="trainingDate">Date:</label>
                    <input type="date" id="trainingDate" required aria-required="true">
                </div>
                <div class="form-group">
                    <label for="trainingType">Training Type:</label>
                    <select id="trainingType" required onchange="toggleOtherInput(event)" aria-required="true">
                        <option value="">-- Select Type --</option>
                        <option value="Dressage">Dressage</option>
                        <option value="Jumping">Jumping</option>
                        <option value="Trail Ride">Trail Ride</option>
                        <option value="Groundwork">Groundwork</option>
                        <option value="Liberty">Liberty</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group other-input" id="otherTrainingTypeInput" style="display:none;">
                    <label for="otherTrainingType">Specify Other Training Type:</label>
                    <input type="text" id="otherTrainingType">
                </div>
                <div class="form-group">
                    <label for="trainingDuration">Duration:</label>
                    <input type="text" id="trainingDuration" placeholder="e.g., 45 minutes, 1 hour 30 minutes">
                </div>
                <div class="form-group">
                    <label for="trainingNotes">Notes/Progress:</label>
                    <textarea id="trainingNotes" rows="3" placeholder="e.g., Focused on lead changes, improved canter transitions."></textarea>
                </div>
                <div class="form-group">
                    <label for="trainingGoals">Goals for Next Session:</label>
                    <textarea id="trainingGoals" rows="2" placeholder="e.g., Work on bending, introduce pole work."></textarea>
                </div>
                <button type="submit" class="btn btn-primary" aria-label="Submit new training session">Add Training Session</button>
            </form>
        </div>
    </div>

    <div id="messageModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('messageModal')" aria-label="Close message dialog">&times;</span>
            <h2 id="messageModalTitle"></h2>
            <p id="messageModalBody"></p>
            <button class="btn btn-primary" onclick="closeModal('messageModal')">OK</button>
        </div>
    </div>

    <div id="confirmModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('confirmModal')" aria-label="Close confirmation dialog">&times;</span>
            <h2 id="confirmModalTitle">Confirm Action</h2>
            <p id="confirmModalBody"></p>
            <div class="modal-actions" style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1.5rem;">
                <button class="btn btn-secondary" id="confirmCancelBtn">Cancel</button>
                <button class="btn btn-danger" id="confirmOkBtn">Confirm</button>
            </div>
        </div>
    </div>

</body>
</html>
