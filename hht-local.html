<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Horse Health Tracker</title>
    <link rel="stylesheet" href="style.css">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* General Styling */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #F8F9FA; /* Light background */
            color: #212529; /* Dark text */
            line-height: 1.6;
            min-height: 100vh;
            font-weight: 400;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #2E86AB 0%, #A23B72 50%, #F18F01 100%); /* Vibrant gradient */
            color: white;
            padding: 1.5rem 0;
            text-align: center;
            box-shadow: 0 10px 40px rgba(46, 134, 171, 0.3); /* Soft shadow */
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            animation: pulse 4s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        h1, h2, h3 {
            color: #343A40;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        p {
            margin-bottom: 0.5rem;
        }

        /* Main Container */
        .container {
            max-width: 1000px;
            margin: 2rem auto;
            padding: 1.5rem;
            background: white;
            border-radius: 20px; /* More rounded corners */
            box-shadow: 0 8px 32px rgba(46, 134, 171, 0.1); /* Subtle shadow */
            flex-grow: 1; /* Allows container to grow and push footer down */
        }

        /* Controls Section (Horse Selector & Add Horse Button) */
        .controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap; /* Allows wrapping on smaller screens */
            align-items: center;
            position: sticky;
            top: 0;
            background: rgba(248, 249, 250, 0.95); /* Semi-transparent background */
            backdrop-filter: blur(10px); /* Blur effect */
            z-index: 10;
            padding: 1rem;
            border-radius: 20px;
            border: 2px solid rgba(46, 134, 171, 0.1);
            box-shadow: 0 8px 32px rgba(46, 134, 171, 0.1);
        }

        .horse-selector {
            flex: 1;
            min-width: 200px;
        }

        .horse-selector label {
            display: block;
            margin-bottom: 0.6rem;
            font-weight: 700;
            color: #2E86AB;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .horse-selector select {
            padding: 1rem 1.25rem;
            border: 3px solid rgba(46, 134, 171, 0.2);
            border-radius: 15px; /* Rounded select */
            font-size: 1rem;
            width: 100%;
            background: white;
            color: #212529;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(46, 134, 171, 0.1);
            -webkit-appearance: none; /* Remove default arrow */
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%232E86AB'%3E%3Cpath d='M7 10l5 5 5-5H7z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1.2rem;
        }

        .horse-selector select:focus {
            outline: none;
            border-color: #2E86AB;
            box-shadow: 0 0 0 4px rgba(46, 134, 171, 0.2);
            transform: scale(1.01);
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 15px; /* Rounded buttons */
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            display: inline-flex; /* Use flex for icon and text alignment */
            align-items: center;
            justify-content: center;
            gap: 0.5rem; /* Space between icon and text */
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.6s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, #2E86AB, #1e5f7a);
            color: white;
            box-shadow: 0 6px 25px rgba(46, 134, 171, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 12px 40px rgba(46, 134, 171, 0.6);
        }

        .btn-success {
            background: linear-gradient(135deg, #28A745, #1e7e34);
            color: white;
            box-shadow: 0 6px 25px rgba(40, 167, 69, 0.4);
        }

        .btn-success:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 12px 40px rgba(40, 167, 69, 0.6);
        }

        .btn-danger {
            background: linear-gradient(135deg, #F18F01, #d17800);
            color: white;
            box-shadow: 0 6px 25px rgba(241, 143, 1, 0.4);
        }

        .btn-danger:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 12px 40px rgba(241, 143, 1, 0.6);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6C757D, #5a6268);
            color: white;
            box-shadow: 0 6px 25px rgba(108, 117, 125, 0.4);
        }

        .btn-secondary:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 12px 40px rgba(108, 117, 125, 0.6);
        }

        /* User ID Display */
        .user-id-display {
            background: #e9ecef;
            border-radius: 10px;
            padding: 0.75rem 1.25rem;
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
            color: #495057;
            text-align: center;
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .user-id-display p {
            margin: 0;
        }

        .user-id-display span {
            font-weight: bold;
            color: #2E86AB;
            word-break: break-all; /* Ensures long IDs wrap */
        }

        /* Upcoming Reminders */
        .upcoming-reminders {
            background: linear-gradient(135deg, rgba(241, 143, 1, 0.05) 0%, rgba(46, 134, 171, 0.05) 100%);
            border: 2px solid rgba(241, 143, 1, 0.2);
            padding: 1.5rem;
            border-radius: 20px;
            margin-bottom: 1.5rem;
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 20px rgba(241, 143, 1, 0.1);
        }

        .upcoming-reminders::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #F18F01, #2E86AB);
        }

        .upcoming-reminders h3 {
            color: #F18F01;
            margin-top: 0;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.2rem;
        }

        .reminder-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid rgba(241, 143, 1, 0.1);
            font-size: 1rem;
            font-weight: 500;
            color: #212529;
        }

        .reminder-item:last-child {
            border-bottom: none;
        }

        .reminder-item.overdue {
            background: linear-gradient(135deg, rgba(241, 143, 1, 0.15) 0%, rgba(162, 59, 114, 0.1) 100%);
            border-color: rgba(241, 143, 1, 0.3);
            animation: urgent 2s ease-in-out infinite;
            padding: 0.75rem; /* Adjust padding for overdue items */
            border-radius: 10px;
        }

        @keyframes urgent {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.01); }
        }

        /* Tab Navigation */
        .tab-container {
            display: flex;
            align-items: center;
            gap: 1rem;
            background: white;
            border-radius: 20px 20px 0 0;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(46, 134, 171, 0.15);
            border: 2px solid rgba(46, 134, 171, 0.1);
        }

        /* Desktop Tabs */
        .tabs {
            display: flex; /* Default to flex for desktop */
            flex: 1;
            background: white;
        }

        .tab {
            flex: 1;
            padding: 1.25rem;
            text-align: center;
            cursor: pointer;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 1rem;
            font-weight: 600;
            color: #6c757d;
            position: relative;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        .tab::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 4px;
            background: linear-gradient(90deg, #2E86AB, #A23B72);
            transition: all 0.3s ease;
            border-radius: 2px 2px 0 0;
        }

        .tab.active {
            background: linear-gradient(135deg, #2E86AB, #1e5f7a);
            color: white;
        }

        .tab.active::after {
            width: 100%;
            left: 0;
        }

        .tab:hover {
            background: linear-gradient(135deg, #e9ecef, #dee2e6);
            color: #212529;
            transform: translateY(-2px);
        }

        /* Mobile Tab Selector (hidden by default) */
        .mobile-tab-selector {
            display: none; /* Hidden by default, shown on mobile */
            flex-shrink: 0;
            padding: 0.5rem;
        }

        .mobile-tab-selector label {
            display: none; /* Hide label, select will be full width */
        }

        .mobile-tab-selector select {
            padding: 0.75rem;
            border: 3px solid rgba(46, 134, 171, 0.2);
            border-radius: 15px;
            font-size: 0.95rem;
            background: white;
            color: #212529;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(46, 134, 171, 0.1);
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%232E86AB'%3E%3Cpath d='M7 10l5 5 5-5H7z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.2rem;
        }

        .mobile-tab-selector select:focus {
            outline: none;
            border-color: #2E86AB;
            box-shadow: 0 0 0 4px rgba(46, 134, 171, 0.2);
        }

        /* Tab Content Areas */
        .tab-content {
            background: white;
            padding: 2rem;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 10px 40px rgba(46, 134, 171, 0.15);
            max-height: 60vh; /* Max height for scrollable content */
            overflow-y: auto; /* Enable scrolling */
            -webkit-overflow-scrolling: touch;
            border: 2px solid rgba(46, 134, 171, 0.1);
            border-top: none; /* No top border as it connects to tabs */
            display: none; /* Hidden by default, shown by JS */
        }

        .tab-content.active {
            display: block; /* Show active tab content */
        }

        .add-record-btn {
            margin-bottom: 1.5rem;
            width: auto; /* Allow button to size naturally */
            min-width: 200px; /* Ensure it's not too small */
        }

        .record-list {
            display: flex;
            flex-direction: column;
            gap: 1.25rem; /* Space between record items */
        }

        .record-item {
            background: linear-gradient(135deg, rgba(46, 134, 171, 0.05) 0%, rgba(248, 249, 250, 0.8) 100%);
            padding: 1.5rem;
            border-radius: 20px;
            border: 2px solid rgba(46, 134, 171, 0.1);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .record-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(46, 134, 171, 0.15);
        }

        .record-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 6px;
            height: 100%;
            background: linear-gradient(180deg, #2E86AB, #A23B72);
            border-radius: 0 3px 3px 0;
        }

        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .record-type {
            font-weight: 800;
            color: #2E86AB;
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .record-date {
            color: #6c757d;
            font-size: 0.9rem;
            font-weight: 600;
            background: rgba(46, 134, 171, 0.1);
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
        }

        .record-details {
            color: #495057;
            margin-top: 0.75rem;
            font-size: 1rem;
            line-height: 1.6;
        }

        .record-details p {
            margin-bottom: 0.25rem;
        }

        .record-details p strong {
            color: #343A40;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
            font-size: 1.1rem;
            font-style: italic;
        }

        /* Modals */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(33, 37, 41, 0.7); /* Dark semi-transparent overlay */
            z-index: 1000; /* High z-index */
            backdrop-filter: blur(8px); /* Blur effect */
            display: flex; /* Use flexbox for centering */
            align-items: center; /* Center vertically */
            justify-content: center; /* Center horizontally */
            padding: 1rem; /* Padding for small screens */
        }

        .modal-content {
            background: linear-gradient(135deg, white 0%, rgba(248, 249, 250, 0.95) 100%);
            padding: 2.5rem;
            border-radius: 25px; /* More rounded */
            max-width: 550px; /* Slightly larger max-width */
            width: 95%; /* Responsive width */
            max-height: 90vh; /* Max height for scrollable modal content */
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            border: 2px solid rgba(46, 134, 171, 0.1);
            box-shadow: 0 25px 80px rgba(46, 134, 171, 0.2);
            position: relative;
            animation: modalFadeIn 0.3s ease-out;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-content h2 {
            color: #2E86AB;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 0; /* Override default h2 margin */
        }

        .close-button {
            font-size: 1.75rem;
            cursor: pointer;
            color: #6c757d;
            transition: all 0.3s ease;
            background: rgba(241, 143, 1, 0.1);
            padding: 0.5rem;
            border-radius: 50%;
        }

        .close-button:hover {
            color: #F18F01;
            background: rgba(241, 143, 1, 0.2);
            transform: scale(1.1);
        }

        /* Form Styling */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.6rem;
            font-weight: 700;
            color: #2E86AB;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="date"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 1rem 1.25rem;
            border: 3px solid rgba(46, 134, 171, 0.2);
            border-radius: 15px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
            color: #212529;
            box-shadow: 0 4px 20px rgba(46, 134, 171, 0.1);
            z-index: 1; /* Ensure inputs are above other elements in stacking context if needed */
        }

        .form-group select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%232E86AB'%3E%3Cpath d='M7 10l5 5 5-5H7z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1.2rem;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #2E86AB;
            box-shadow: 0 0 0 4px rgba(46, 134, 171, 0.2);
            transform: scale(1.01);
            z-index: 2; /* Bring focused input to front */
        }

        .form-row {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap; /* Allow wrapping */
        }

        .form-row .form-group {
            flex: 1;
            min-width: 150px; /* Ensures inputs have a minimum width */
            margin-bottom: 0; /* Remove extra margin when in a row */
        }

        .other-input {
            display: none; /* Hidden by default */
        }

        /* Footer Controls */
        .footer-controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 1rem;
            padding: 1rem;
            background: rgba(248, 249, 250, 0.95);
            backdrop-filter: blur(10px);
            border-top: 2px solid rgba(46, 134, 171, 0.1);
            box-shadow: 0 -8px 32px rgba(46, 134, 171, 0.1);
            z-index: 10;
            flex-wrap: wrap; /* Allow wrapping on small screens */
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 12px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(248, 249, 250, 0.8);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #2E86AB, #A23B72);
            border-radius: 10px;
            border: 2px solid rgba(248, 249, 250, 0.8);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #1e5f7a, #7a2c56);
        }

        /* Active Button Animation */
        .btn:active {
            animation: bounce 0.6s ease;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        /* Accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
                margin: 1rem auto 5rem auto; /* Adjust margin to account for fixed footer */
            }
            
            .form-row {
                flex-direction: column;
                gap: 1rem;
            }
            
            .controls {
                flex-wrap: wrap;
                align-items: stretch;
                gap: 0.75rem;
                padding: 0.75rem;
            }
            
            .horse-selector {
                flex: 1 1 100%;
                min-width: 0;
            }
            
            .btn-primary {
                flex: 1 1 auto;
                width: 100%;
            }
            
            .footer-controls {
                padding: 0.75rem;
                gap: 0.75rem;
            }
            
            /* Hide desktop tabs on mobile */
            .tabs {
                display: none;
            }
            
            /* Show mobile selector on mobile */
            .mobile-tab-selector {
                display: block;
            }

            .tab-container {
                flex-direction: row; /* Keep flex-direction for mobile selector and potential other elements */
                align-items: center;
                gap: 0.5rem;
            }

            .mobile-tab-selector select {
                width: 100%;
            }

            .tab-content {
                max-height: 50vh; /* Constrain height for scrolling on small screens */
                padding: 1.5rem;
            }

            .modal-content {
                margin: 2% auto;
                max-width: 95%;
                padding: 2rem;
            }

            .btn {
                padding: 0.75rem 1.25rem;
                font-size: 0.9rem;
            }

            .form-group select {
                padding: 1rem 2rem;
                background-size: 1.5rem;
                touch-action: manipulation; /* Improves responsiveness for selects */
            }
        }

        @media (min-width: 769px) {
            /* Hide mobile selector on desktop */
            .mobile-tab-selector {
                display: none;
            }

            /* Ensure desktop tabs are visible */
            .tabs {
                display: flex; /* Explicitly show tabs on desktop */
            }
        }

    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script>
        // Data storage (using localStorage as per original request)
        let horses = JSON.parse(localStorage.getItem('horses')) || [];
        let selectedHorse = null;

        // --- Utility Functions ---

        /**
         * Displays a custom message modal instead of a native alert.
         * @param {string} title - The title of the message.
         * @param {string} body - The body content of the message.
         */
        function showMessage(title, body) {
            document.getElementById('messageModalTitle').textContent = title;
            document.getElementById('messageModalBody').textContent = body;
            openModal('messageModal');
        }

        /**
         * Displays a custom confirmation modal.
         * @param {string} title - The title of the confirmation.
         * @param {string} body - The body content of the confirmation.
         * @returns {Promise<boolean>} A promise that resolves to true if confirmed, false otherwise.
         */
        function showConfirm(title, body) {
            return new Promise((resolve) => {
                document.getElementById('confirmModalTitle').textContent = title;
                document.getElementById('confirmModalBody').textContent = body;
                openModal('confirmModal');

                const confirmOkBtn = document.getElementById('confirmOkBtn');
                const confirmCancelBtn = document.getElementById('confirmCancelBtn');

                const handleConfirm = () => {
                    closeModal('confirmModal');
                    confirmOkBtn.removeEventListener('click', handleConfirm);
                    confirmCancelBtn.removeEventListener('click', handleCancel);
                    resolve(true);
                };

                const handleCancel = () => {
                    closeModal('confirmModal');
                    confirmOkBtn.removeEventListener('click', handleConfirm);
                    confirmCancelBtn.removeEventListener('click', handleCancel);
                    resolve(false);
                };

                confirmOkBtn.addEventListener('click', handleConfirm);
                confirmCancelBtn.addEventListener('click', handleCancel);
            });
        }

        /**
         * Saves the current 'horses' array to localStorage.
         */
        function saveData() {
            localStorage.setItem('horses', JSON.stringify(horses));
            console.log('Data saved to localStorage.');
        }

        /**
         * Formats a date string to a localized string (e.g., DD/MM/YYYY for en-AU).
         * @param {string} dateString - The date string to format.
         * @returns {string} The formatted date string.
         */
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            // Check if the date is valid
            if (isNaN(date.getTime())) {
                console.warn('Invalid date string provided to formatDate:', dateString); // Added for debugging
                return 'Invalid Date';
            }
            // Formatting for Australian date context (DD/MM/YYYY)
            const formattedDate = date.toLocaleDateString('en-AU', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
            console.log(`Formatted date "${dateString}" to "${formattedDate}" (en-AU).`); // Added for debugging
            return formattedDate;
        }

        /**
         * Capitalizes the first letter of a string.
         * @param {string} str - The input string.
         * @returns {string} The string with the first letter capitalized.
         */
        function capitalizeFirst(str) {
            if (!str) return '';
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        // --- Modal Functions ---

        /**
         * Opens a specified modal.
         * @param {string} modalId - The ID of the modal to open.
         */
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'flex'; // Use flex to center the modal content
                // Reset forms when opening modals, but only for input modals, not message/confirm modals
                if (modalId !== 'messageModal' && modalId !== 'confirmModal') {
                    const form = modal.querySelector('form');
                    if (form) {
                        form.reset();
                        // Reset "Other" input visibility if present
                        const otherInputDiv = form.querySelector('.other-input');
                        if (otherInputDiv) {
                            otherInputDiv.style.display = 'none';
                            const otherInputField = otherInputDiv.querySelector('input, textarea');
                            if (otherInputField) {
                                otherInputField.value = '';
                                otherInputField.removeAttribute('required'); // Remove required attribute when hidden
                            }
                        }
                    }
                }
            } else {
                console.error(`Error: Modal ${modalId} not found`);
                showMessage('Error', `Modal "${modalId}" not found.`);
            }
        }

        /**
         * Closes a specified modal.
         * @param {string} modalId - The ID of the modal to close.
         */
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
            } else {
                console.error(`Error: Modal ${modalId} not found`);
                showMessage('Error', `Modal "${modalId}" not found.`);
            }
        }

        // Close modals when clicking outside of them
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        };

        // --- "Other" Input Toggling ---

        /**
         * Toggles the visibility of an "Other" input field based on select dropdown value.
         * @param {Event} event - The change event from the select element.
         */
        function toggleOtherInput(event) {
            const selectElement = event.target;
            // Find the parent form-group, then look for the .other-input div within it
            const formGroup = selectElement.closest('.form-group');
            if (!formGroup) {
                console.error('toggleOtherInput: Parent form-group not found.');
                return;
            }
            const otherInputDiv = formGroup.nextElementSibling; // Assuming other-input is sibling
            
            // Check if the next sibling is indeed an "other-input" and has the correct ID structure
            if (otherInputDiv && otherInputDiv.classList.contains('other-input')) {
                const otherInputField = otherInputDiv.querySelector('input, textarea');
                if (!otherInputField) {
                    console.error('toggleOtherInput: Other input field not found within .other-input div.');
                    return;
                }

                if (selectElement.value === 'Other') {
                    otherInputDiv.style.display = 'block';
                    otherInputField.setAttribute('required', 'required');
                } else {
                    otherInputDiv.style.display = 'none';
                    otherInputField.removeAttribute('required');
                    otherInputField.value = ''; // Clear value when hidden
                }
            }
        }


        // --- Horse Management Functions ---

        /**
         * Loads horses into the select dropdown.
         */
        function loadHorses() {
            const horseSelect = document.getElementById('horseSelect');
            horseSelect.innerHTML = '<option value="">-- Select a horse --</option>'; // Clear existing options

            horses.forEach((horse, index) => {
                // Ensure horse.records and its sub-arrays are initialized
                horse.records = horse.records || {};
                horse.records.vaccinations = horse.records.vaccinations || [];
                horse.records.deworming = horse.records.deworming || [];
                horse.records.farrier = horse.records.farrier || [];
                horse.records.veterinary = horse.records.veterinary || [];

                const option = document.createElement('option');
                option.value = index; // Use array index as value for localStorage
                option.textContent = horse.name;
                horseSelect.appendChild(option);
            });

            // If a horse was previously selected, try to re-select it
            // This handles cases where data is reloaded or page refreshes
            if (selectedHorse !== null && horses[selectedHorse.index]) {
                horseSelect.value = selectedHorse.index;
                // Directly reference the object in the array
                selectedHorse = horses[selectedHorse.index]; 
                selectedHorse.index = parseInt(horseSelect.value); // Ensure index is correct
                loadHorseData();
            } else {
                selectedHorse = null;
                document.getElementById('horseContent').style.display = 'none';
            }
            updateReminders();
        }

        /**
         * Adds a new horse.
         * @param {Event} e - The form submission event.
         */
        function addHorse(e) {
            e.preventDefault();
            
            const name = document.getElementById('horseName').value.trim();
            if (!name) {
                showMessage('Input Required', 'Horse name is required.');
                return;
            }
            
            const breed = document.getElementById('horseBreed').value.trim();
            const age = document.getElementById('horseAge').value.trim();
            const colour = document.getElementById('horseColour').value.trim();
            
            const horse = {
                name: name,
                breed: breed || 'Not specified',
                age: age || 'Not specified',
                colour: colour || 'Not specified',
                records: { // Initialize empty records for all categories
                    vaccinations: [],
                    deworming: [],
                    farrier: [],
                    veterinary: []
                }
            };
            
            horses.push(horse);
            saveData();
            loadHorses();
            closeModal('addHorseModal');
            document.getElementById('addHorseForm').reset();
            showMessage('Success', 'Horse added successfully!');
        }

        /**
         * Switches the currently selected horse in the UI.
         */
        function switchHorse() {
            const horseSelect = document.getElementById('horseSelect');
            const horseIndex = parseInt(horseSelect.value); // Parse to integer
            
            if (isNaN(horseIndex) || horseIndex < 0 || horseIndex >= horses.length) { // Check for valid index
                selectedHorse = null;
                document.getElementById('horseContent').style.display = 'none';
                return;
            }
            
            selectedHorse = horses[horseIndex]; // Direct reference
            selectedHorse.index = horseIndex; // Store index for convenience if needed elsewhere
            document.getElementById('horseContent').style.display = 'block';
            // Ensure overview tab is active by default when switching horse
            document.getElementById('tabSelect').value = 'overview';
            switchTab('overview'); 
            loadHorseData(); // Load data for the newly selected horse
        }

        /**
         * Loads all data for the currently selected horse into the respective tab panes.
         */
        function loadHorseData() {
            if (!selectedHorse) {
                return;
            }
            loadOverview();
            loadRecords('vaccinations', 'vaccinationRecords');
            loadRecords('deworming', 'dewormingRecords');
            loadRecords('farrier', 'farrierRecords');
            loadRecords('veterinary', 'veterinaryRecords');
        }

        /**
         * Populates the overview tab with horse details and recent activity.
         */
        function loadOverview() {
            if (!selectedHorse) {
                return;
            }
            const overviewContent = document.getElementById('overviewContent');
            
            let html = `
                <div class="record-item">
                    <h3>${selectedHorse.name || 'Unknown Horse'}</h3>
                    <p><strong>Breed:</strong> ${selectedHorse.breed || 'Not specified'}</p>
                    <p><strong>Age:</strong> ${selectedHorse.age || 'Not specified'}</p>
                    <p><strong>Colour:</strong> ${selectedHorse.colour || 'Not specified'}</p>
                </div>
            `;
            
            const allRecords = [];
            // Combine all records for recent activity display
            Object.keys(selectedHorse.records || {}).forEach(type => {
                if (selectedHorse.records[type] && Array.isArray(selectedHorse.records[type])) {
                    selectedHorse.records[type].forEach(record => {
                        allRecords.push({...record, type: type});
                    });
                }
            });
            
            allRecords.sort((a, b) => new Date(b.date) - new Date(a.date)); // Sort by date descending
            
            if (allRecords.length > 0) {
                html += '<h3>Recent Activity</h3>';
                allRecords.slice(0, 5).forEach(record => { // Show up to 5 recent activities
                    html += `
                        <div class="record-item">
                            <div class="record-header">
                                <span class="record-type">${capitalizeFirst(record.type)}</span>
                                <span class="record-date">${formatDate(record.date)}</span>
                            </div>
                            <div class="record-details">
                                ${getRecordSummary(record)}
                            </div>
                        </div>
                    `;
                });
            } else {
                html += '<div class="empty-state">No records yet. Add health records to start!</div>';
            }
            
            overviewContent.innerHTML = html;
        }

        /**
         * Populates a specific record tab (e.g., vaccinations, deworming).
         * @param {string} type - The type of record (e.g., 'vaccinations').
         * @param {string} containerId - The ID of the HTML container for these records.
         */
        function loadRecords(type, containerId) {
            if (!selectedHorse) {
                return;
            }
            const container = document.getElementById(containerId);
            const records = selectedHorse.records?.[type] || [];
            
            if (records.length === 0) {
                container.innerHTML = '<div class="empty-state">No records yet. Click + Add to start.</div>';
                return;
            }
            
            const sortedRecords = records.sort((a, b) => new Date(b.date) - new Date(a.date));
            const fragment = document.createDocumentFragment();
            
            sortedRecords.forEach((record, index) => {
                const recordDiv = document.createElement('div');
                recordDiv.className = 'record-item';
                recordDiv.innerHTML = `
                    <div class="record-header">
                        <span class="record-type">${getRecordTitle(record, type)}</span>
                        <div>
                            <span class="record-date">${formatDate(record.date)}</span>
                            <button class="btn btn-danger" onclick="deleteRecord('${type}', ${index})" aria-label="Delete this record">
                                <i class="fas fa-trash-alt"></i> Delete
                            </button>
                        </div>
                    </div>
                    <div class="record-details">
                        ${getRecordDetails(record, type)}
                    </div>
                `;
                fragment.appendChild(recordDiv);
            });
            
            container.innerHTML = ''; // Clear previous content
            container.appendChild(fragment);
        }

        /**
         * Gets a descriptive title for a record based on its type.
         * @param {object} record - The record object.
         * @param {string} type - The type of record.
         * @returns {string} The descriptive title.
         */
        function getRecordTitle(record, type) {
            switch(type) {
                case 'vaccinations':
                    return record.type || 'Vaccination';
                case 'deworming':
                    return record.product || 'Deworming';
                case 'farrier':
                    return record.service || 'Farrier Visit';
                case 'veterinary':
                    return record.visitType || 'Veterinary Visit';
                default:
                    return 'Record';
            }
        }

        /**
         * Gets detailed HTML content for a record based on its type.
         * @param {object} record - The record object.
         * @param {string} type - The type of record.
         * @returns {string} HTML string with record details.
         */
        function getRecordDetails(record, type) {
            let details = '';
            
            switch(type) {
                case 'vaccinations':
                    if (record.veterinarian) details += `<p><strong>Veterinarian:</strong> ${record.veterinarian}</p>`;
                    if (record.nextDue) details += `<p><strong>Next Due:</strong> ${formatDate(record.nextDue)}</p>`;
                    if (record.notes) details += `<p><strong>Notes:</strong> ${record.notes}</p>`;
                    break;
                case 'deworming':
                    if (record.weight) details += `<p><strong>Weight:</strong> ${record.weight} kg</p>`;
                    if (record.nextDue) details += `<p><strong>Next Due:</strong> ${formatDate(record.nextDue)}</p>`;
                    if (record.notes) details += `<p><strong>Notes:</strong> ${record.notes}</p>`;
                    break;
                case 'farrier':
                    if (record.farrier) details += `<p><strong>Farrier:</strong> ${record.farrier}</p>`;
                    if (record.cost) details += `<p><strong>Cost:</strong> $${parseFloat(record.cost).toFixed(2)}</p>`;
                    if (record.nextDue) details += `<p><strong>Next Due:</strong> ${formatDate(record.nextDue)}</p>`;
                    if (record.notes) details += `<p><strong>Notes:</strong> ${record.notes}</p>`;
                    break;
                case 'veterinary':
                    if (record.veterinarian) details += `<p><strong>Veterinarian:</strong> ${record.veterinarian}</p>`;
                    if (record.diagnosis) details += `<p><strong>Diagnosis:</strong> ${record.diagnosis}</p>`;
                    if (record.treatment) details += `<p><strong>Treatment:</strong> ${record.treatment}</p>`;
                    if (record.cost) details += `<p><strong>Cost:</strong> $${parseFloat(record.cost).toFixed(2)}</p>`;
                    if (record.nextDue) details += `<p><strong>Next Check-up:</strong> ${formatDate(record.nextDue)}</p>`;
                    if (record.notes) details += `<p><strong>Notes:</strong> ${record.notes}</p>`;
                    break;
            }
            return details;
        }

        /**
         * Gets a summary string for a record, used in the overview tab.
         * @param {object} record - The record object.
         * @returns {string} A brief summary of the record.
         */
        function getRecordSummary(record) {
            switch(record.type) {
                case 'vaccinations':
                    return `${record.type || 'Vaccination'} administered`;
                case 'deworming':
                    return `${record.product || 'Deworming'} administered`;
                case 'farrier':
                    return `${record.service || 'Farrier visit'} by ${record.farrier || 'Farrier'}`;
                case 'veterinary':
                    return `${record.visitType || 'Veterinary visit'} by ${record.veterinarian || 'Veterinarian'}`;
                default:
                    return 'Health record updated';
            }
        }

        /**
         * Deletes a specific record from the selected horse's data.
         * @param {string} type - The type of record (e.g., 'vaccinations').
         * @param {number} index - The index of the record in the array to delete.
         */
        async function deleteRecord(type, index) {
            if (selectedHorse === null) {
                showMessage('Error', 'Please select a horse first.');
                return;
            }

            const confirmed = await showConfirm('Delete Record', 'Are you sure you want to delete this record? This action cannot be undone.');
            if (!confirmed) {
                return;
            }

            if (selectedHorse.records && selectedHorse.records[type] && selectedHorse.records[type][index]) {
                selectedHorse.records[type].splice(index, 1); // Remove the record
                // No need to re-assign selectedHorse to horses[selectedHorse.index] here
                // as selectedHorse is now a direct reference
                saveData();
                loadHorseData(); // Reload data for the current horse
                updateReminders();
                showMessage('Success', 'Record deleted successfully!');
            } else {
                showMessage('Error', 'Record not found.');
            }
        }

        // --- Add Record Functions (Local Storage) ---

        /**
         * Adds a vaccination record to the selected horse.
         * @param {Event} e - The form submission event.
         */
        function addVaccination(e) {
            e.preventDefault();
            if (selectedHorse === null) {
                showMessage('Error', 'Please select a horse first.');
                return;
            }
            
            const vaccineType = document.getElementById('vaccineType').value;
            const otherType = document.getElementById('otherVaccineType').value.trim();
            const date = document.getElementById('vaccineDate').value;
            const nextDue = document.getElementById('vaccineNextDue').value;
            const veterinarian = document.getElementById('vaccineVet').value.trim();
            const notes = document.getElementById('vaccineNotes').value.trim();
            
            const finalType = vaccineType === 'Other' ? otherType : vaccineType;

            if (!date || !finalType) {
                showMessage('Input Required', 'Date and Vaccine Type are required.');
                return;
            }
            
            const vaccination = {
                type: finalType,
                date: date,
                nextDue: nextDue,
                veterinarian: veterinarian,
                notes: notes
            };
            
            selectedHorse.records.vaccinations.push(vaccination);
            // No need to re-assign selectedHorse to horses[selectedHorse.index] here
            // as selectedHorse is now a direct reference
            saveData();
            loadHorseData();
            closeModal('addVaccinationModal');
            document.getElementById('addVaccinationForm').reset();
            showMessage('Success', 'Vaccination added successfully!');
            console.log('Vaccination added:', vaccination); // Add log for debugging
        }

        /**
         * Adds a deworming record to the selected horse.
         * @param {Event} e - The form submission event.
         */
        function addDeworming(e) {
            e.preventDefault();
            if (selectedHorse === null) {
                showMessage('Error', 'Please select a horse first.');
                return;
            }
            
            const product = document.getElementById('dewormingProduct').value;
            const otherProduct = document.getElementById('otherDewormingProduct').value.trim();
            const date = document.getElementById('dewormingDate').value;
            const nextDue = document.getElementById('dewormingNextDue').value;
            const weight = document.getElementById('dewormingWeight').value;
            const notes = document.getElementById('dewormingNotes').value.trim();

            const finalProduct = product === 'Other' ? otherProduct : product;

            if (!date || !finalProduct) {
                showMessage('Input Required', 'Date and Deworming Product are required.');
                return;
            }
            
            const deworming = {
                product: finalProduct,
                date: date,
                nextDue: nextDue,
                weight: parseFloat(weight) || 0,
                notes: notes
            };
            
            selectedHorse.records.deworming.push(deworming);
            // No need to re-assign selectedHorse to horses[selectedHorse.index] here
            saveData();
            loadHorseData();
            closeModal('addDewormingModal');
            document.getElementById('addDewormingForm').reset();
            showMessage('Success', 'Deworming record added successfully!');
            console.log('Deworming added:', deworming); // Add log for debugging
        }

        /**
         * Adds a farrier visit record to the selected horse.
         * @param {Event} e - The form submission event.
         */
        function addFarrier(e) {
            e.preventDefault();
            if (selectedHorse === null) {
                showMessage('Error', 'Please select a horse first.');
                return;
            }
            
            const service = document.getElementById('farrierService').value;
            const otherService = document.getElementById('otherFarrierService').value.trim();
            const date = document.getElementById('farrierDate').value;
            const nextDue = document.getElementById('farrierNextDue').value;
            const farrier = document.getElementById('farrierName').value.trim();
            const cost = document.getElementById('farrierCost').value;
            const notes = document.getElementById('farrierNotes').value.trim();

            const finalService = service === 'Other' ? otherService : service;

            if (!date || !finalService) {
                showMessage('Input Required', 'Date and Service Type are required.');
                return;
            }
            
            const farrierVisit = {
                service: finalService,
                date: date,
                nextDue: nextDue,
                farrier: farrier,
                cost: parseFloat(cost) || 0,
                notes: notes
            };
            
            selectedHorse.records.farrier.push(farrierVisit);
            // No need to re-assign selectedHorse to horses[selectedHorse.index] here
            saveData();
            loadHorseData();
            closeModal('addFarrierModal');
            document.getElementById('addFarrierForm').reset();
            showMessage('Success', 'Farrier visit added successfully!');
            console.log('Farrier visit added:', farrierVisit); // Add log for debugging
        }

        /**
         * Adds a veterinary visit record to the selected horse.
         * @param {Event} e - The form submission event.
         */
        function addVeterinary(e) {
            e.preventDefault();
            if (selectedHorse === null) {
                showMessage('Error', 'Please select a horse first.');
                return;
            }
            
            try { // Added try-catch for better error reporting
                const visitType = document.getElementById('vetVisitType').value;
                const otherVisitType = document.getElementById('otherVetVisitType').value.trim();
                const date = document.getElementById('vetDate').value;
                const nextDue = document.getElementById('vetNextDue').value;
                const veterinarian = document.getElementById('vetName').value.trim();
                const diagnosis = document.getElementById('vetDiagnosis').value.trim();
                const treatment = document.getElementById('vetTreatment').value.trim();
                const cost = document.getElementById('vetCost').value;
                const notes = document.getElementById('vetNotes').value.trim();

                const finalVisitType = visitType === 'Other' ? otherVisitType : visitType;

                if (!date || !finalVisitType) {
                    showMessage('Input Required', 'Date and Visit Type are required.');
                    console.error('Validation failed: Date or Visit Type missing.'); // Added for debugging
                    return;
                }
                
                const veterinaryVisit = {
                    visitType: finalVisitType,
                    date: date,
                    nextDue: nextDue,
                    veterinarian: veterinarian,
                    diagnosis: diagnosis,
                    treatment: treatment,
                    cost: parseFloat(cost) || 0,
                    notes: notes
                };
                
                console.log('Attempting to add veterinary visit:', veterinaryVisit); // Added for debugging
                selectedHorse.records.veterinary.push(veterinaryVisit);
                console.log('Current selectedHorse.records.veterinary after push:', selectedHorse.records.veterinary); // Added for debugging

                saveData();
                loadHorseData();
                closeModal('addVeterinaryModal');
                document.getElementById('addVeterinaryForm').reset();
                showMessage('Success', 'Veterinary visit added successfully!');
                console.log('Veterinary visit added and saved:', veterinaryVisit); // Added for debugging
            } catch (error) {
                console.error("Error in addVeterinary function: ", error); // Catch and log any errors
                showMessage('Error', `Failed to add veterinary visit: ${error.message}. Check console for details.`);
            }
        }

        // --- Reminder System ---

        /**
         * Updates and displays upcoming and overdue care reminders.
         */
        function updateReminders() {
            const remindersList = document.getElementById('remindersList');
            const upcomingRemindersDiv = document.getElementById('upcomingReminders');
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalize to start of day
            const upcomingDaysThreshold = 30; // Reminders for next 30 days

            let allReminders = [];

            horses.forEach(horse => {
                if (horse.records) {
                    Object.keys(horse.records).forEach(recordType => {
                        if (Array.isArray(horse.records[recordType])) {
                            horse.records[recordType].forEach(record => {
                                if (record.nextDue) {
                                    const dueDate = new Date(record.nextDue);
                                    dueDate.setHours(0, 0, 0, 0); // Normalize to start of day

                                    const daysDiff = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));

                                    if (daysDiff <= upcomingDaysThreshold) { // Include overdue and upcoming within threshold
                                        const typeMap = {
                                            'vaccinations': 'Vaccination',
                                            'deworming': 'Deworming',
                                            'farrier': 'Farrier',
                                            'veterinary': 'Vet Visit'
                                        };
                                        allReminders.push({
                                            horseName: horse.name,
                                            type: typeMap[recordType] || capitalizeFirst(recordType),
                                            item: getReminderItemName(record, recordType),
                                            dueDate: dueDate,
                                            daysDiff: daysDiff,
                                            overdue: daysDiff < 0
                                        });
                                    }
                                }
                            });
                        }
                    });
                }
            });

            allReminders.sort((a, b) => a.dueDate - b.dueDate); // Sort by due date

            if (allReminders.length > 0) {
                remindersList.innerHTML = '';
                const fragment = document.createDocumentFragment();
                allReminders.forEach(reminder => {
                    const className = reminder.overdue ? 'reminder-item overdue' : 'reminder-item';
                    const statusText = reminder.overdue ?
                        `Overdue by ${Math.abs(reminder.daysDiff)} days` :
                        reminder.daysDiff === 0 ? 'Due today' : `Due in ${reminder.daysDiff} days`;

                    const reminderItem = document.createElement('div');
                    reminderItem.className = className;
                    reminderItem.innerHTML = `
                        <div>
                            <strong>${reminder.horseName}</strong> - ${reminder.item} (${reminder.type})
                        </div>
                        <div style="color: ${reminder.overdue ? '#DC3545' : '#007BFF'};">
                            ${statusText}
                        </div>
                    `;
                    fragment.appendChild(reminderItem);
                });
                remindersList.appendChild(fragment);
                upcomingRemindersDiv.style.display = 'block';
            } else {
                upcomingRemindersDiv.style.display = 'none';
                remindersList.innerHTML = '';
            }
        }

        /**
         * Gets the specific item name for a reminder (e.g., vaccine type, deworming product).
         * @param {object} record - The record object.
         * @param {string} type - The type of record.
         * @returns {string} The item name.
         */
        function getReminderItemName(record, type) {
            switch(type) {
                case 'vaccinations': return record.type;
                case 'deworming': return record.product;
                case 'farrier': return record.service;
                case 'veterinary': return record.visitType;
                default: return '';
            }
        }

        // --- Tab Switching Logic ---

        /**
         * Switches the active tab and loads content for it.
         * @param {string} tabId - The ID of the tab to activate (e.g., 'overview', 'vaccinations').
         */
        function switchTab(tabId) {
            // Hide all tab content panes
            document.querySelectorAll('.tab-content').forEach(pane => {
                pane.classList.remove('active');
            });
            
            // Deactivate all tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Activate the selected tab content pane
            const selectedPane = document.getElementById(`${tabId}Content`);
            if (selectedPane) {
                selectedPane.classList.add('active');
            } else {
                console.error(`Tab content for ID "${tabId}Content" not found.`);
            }
            
            // Activate the corresponding tab button (for desktop view)
            const selectedTabButton = document.querySelector(`.tab[data-tab="${tabId}"]`);
            if (selectedTabButton) {
                selectedTabButton.classList.add('active');
            }

            // Update the mobile dropdown selector
            const mobileTabSelect = document.getElementById('tabSelect');
            if (mobileTabSelect) {
                mobileTabSelect.value = tabId;
            }

            // Load data specific to the tab if a horse is selected
            if (selectedHorse) {
                loadHorseData(); // This function will call the specific loadRecords/loadOverview based on active tab
            } else {
                // If no horse is selected, clear content of all tabs
                document.querySelectorAll('.record-list').forEach(list => list.innerHTML = '<div class="empty-state">Please select a horse to view records.</div>');
                document.getElementById('overviewContent').innerHTML = '<div class="empty-state">Please select a horse to view overview.</div>';
            }
        }

        // --- Data Import/Export ---

        /**
         * Exports all horse data to a JSON file.
         */
        function exportData() {
            const dataStr = JSON.stringify(horses, null, 2); // Pretty print JSON
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'horse_health_data.json';
            link.click();
            URL.revokeObjectURL(url); // Clean up the URL object
            showMessage('Export Complete', 'Your horse data has been exported as "horse_health_data.json".');
        }

        /**
         * Triggers the hidden file input to open the import dialog.
         */
        function importData() {
            document.getElementById('importFile').click();
        }

        /**
         * Handles the file selection for importing data.
         * @param {Event} event - The change event from the file input.
         */
        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const importedHorses = JSON.parse(e.target.result);
                    if (Array.isArray(importedHorses)) {
                        const confirmed = await showConfirm('Import Data', 'Importing will overwrite existing data. Are you sure?');
                        if (!confirmed) {
                            return;
                        }

                        horses = importedHorses;
                        saveData();
                        loadHorses();
                        updateReminders();
                        showMessage('Import Complete', 'Data imported successfully!');
                    } else {
                        showMessage('Invalid File', 'Invalid file format. Please select a valid JSON file.');
                    }
                } catch (error) {
                    console.error("Error reading or importing file: ", error);
                    showMessage('Error', `Error reading file. Please make sure it's a valid JSON file. Details: ${error.message}`);
                }
            };
            reader.readAsText(file);
        }

        // --- Initialization ---

        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded. Initializing app...');

            // Initial load of horses and reminders
            loadHorses();
            updateReminders();
            
            // Attach form submission listeners
            const addHorseForm = document.getElementById('addHorseForm');
            if (addHorseForm) {
                addHorseForm.addEventListener('submit', addHorse);
            } else {
                // This is a critical error, show a message
                showMessage('Initialization Error', 'Add Horse form not found. The application may not function correctly.');
                console.error('Error: Add Horse form not found');
            }
            
            // Attach event listeners for all other forms and elements
            document.getElementById('addVaccinationForm').addEventListener('submit', addVaccination);
            document.getElementById('addDewormingForm').addEventListener('submit', addDeworming);
            document.getElementById('addFarrierForm').addEventListener('submit', addFarrier);
            document.getElementById('addVeterinaryForm').addEventListener('submit', addVeterinary);
            
            // Attach change listeners for "Other" input toggling
            document.getElementById('vaccineType').addEventListener('change', toggleOtherInput);
            document.getElementById('dewormingProduct').addEventListener('change', toggleOtherInput);
            document.getElementById('farrierService').addEventListener('change', toggleOtherInput);
            document.getElementById('vetVisitType').addEventListener('change', toggleOtherInput);

            // Attach import file listener
            document.getElementById('importFile').addEventListener('change', handleImport);

            // Ensure no service modals are open on load by explicitly closing them
            closeModal('addHorseModal'); // Ensure add horse modal is also closed
            closeModal('addVaccinationModal');
            closeModal('addDewormingModal');
            closeModal('addFarrierModal');
            closeModal('addVeterinaryModal');
            closeModal('messageModal'); // Ensure message modal is closed
            closeModal('confirmModal'); // Ensure confirm modal is closed

            // Set the initial tab to overview
            switchTab('overview');
        });

    </script>
</head>
<body>
    <div class="header">
        <h1> Horse Health Tracker</h1>
        <p>Track your horses' health records and care</p>
    </div>

    <div class="container">
        <div class="controls">
            <div class="horse-selector">
                <label for="horseSelect">Select Horse:</label>
                <select id="horseSelect" onchange="switchHorse()" aria-label="Select a horse">
                    <option value="">-- Select a horse --</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="openModal('addHorseModal')" aria-label="Add new horse">+ Add Horse</button>
        </div>

        <!-- User ID display is removed as Firebase is no longer used -->

        <div id="upcomingReminders" class="upcoming-reminders" style="display: none;">
            <h3> Upcoming & Overdue Care</h3>
            <div id="remindersList"></div>
        </div>

        <div id="horseContent" style="display: none;">
            <div class="tab-container">
                <!-- Desktop Tabs -->
                <div class="tabs">
                    <button class="tab active" data-tab="overview" onclick="switchTab('overview')" aria-label="View health overview">Overview</button>
                    <button class="tab" data-tab="vaccinations" onclick="switchTab('vaccinations')" aria-label="View vaccination records">Vaccinations</button>
                    <button class="tab" data-tab="deworming" onclick="switchTab('deworming')" aria-label="View deworming records">Deworming</button>
                    <button class="tab" data-tab="farrier" onclick="switchTab('farrier')" aria-label="View farrier records">Farrier</button>
                    <button class="tab" data-tab="veterinary" onclick="switchTab('veterinary')" aria-label="View veterinary records">Veterinary</button>
                </div>
                <!-- Mobile Tab Selector -->
                <div class="mobile-tab-selector">
                    <label for="tabSelect" class="sr-only">Select Tab</label>
                    <select id="tabSelect" onchange="switchTab(this.value)" aria-label="Select a health record category">
                        <option value="overview">Overview</option>
                        <option value="vaccinations">Vaccinations</option>
                        <option value="deworming">Deworming</option>
                        <option value="farrier">Farrier</option>
                        <option value="veterinary">Veterinary</option>
                    </select>
                </div>
            </div>

            <div id="overviewContent" class="tab-content active">
                <!-- Overview content will be loaded here by JavaScript -->
            </div>
            <div id="vaccinationsContent" class="tab-content">
                <button class="btn btn-success add-record-btn" onclick="openModal('addVaccinationModal')" aria-label="Add new vaccination record">
                    <i class="fas fa-plus"></i> Add Vaccination
                </button>
                <div id="vaccinationRecords" class="record-list">
                    <!-- Vaccination records will be loaded here by JavaScript -->
                </div>
            </div>
            <div id="dewormingContent" class="tab-content">
                <button class="btn btn-success add-record-btn" onclick="openModal('addDewormingModal')" aria-label="Add new deworming record">
                    <i class="fas fa-plus"></i> Add Deworming
                </button>
                <div id="dewormingRecords" class="record-list">
                    <!-- Deworming records will be loaded here by JavaScript -->
                </div>
            </div>
            <div id="farrierContent" class="tab-content">
                <button class="btn btn-success add-record-btn" onclick="openModal('addFarrierModal')" aria-label="Add new farrier visit record">
                    <i class="fas fa-plus"></i> Add Farrier Visit
                </button>
                <div id="farrierRecords" class="record-list">
                    <!-- Farrier records will be loaded here by JavaScript -->
                </div>
            </div>
            <div id="veterinaryContent" class="tab-content">
                <button class="btn btn-success add-record-btn" onclick="openModal('addVeterinaryModal')" aria-label="Add new veterinary visit record">
                    <i class="fas fa-plus"></i> Add Veterinary Visit
                </button>
                <div id="veterinaryRecords" class="record-list">
                    <!-- Veterinary records will be loaded here by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <div class="footer-controls">
        <button class="btn btn-secondary" onclick="exportData()" aria-label="Export all horse data">
            <i class="fas fa-download"></i> Export Data
        </button>
        <button class="btn btn-secondary" onclick="importData()" aria-label="Import horse data from file">
            <i class="fas fa-upload"></i> Import Data
        </button>
        <input type="file" id="importFile" accept=".json" style="display: none;">
    </div>

    <!-- Modals -->

    <!-- Add Horse Modal -->
    <div id="addHorseModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('addHorseModal')" aria-label="Close add horse dialog">&times;</span>
            <h2>Add New Horse</h2>
            <form id="addHorseForm">
                <div class="form-group">
                    <label for="horseName">Horse Name:</label>
                    <input type="text" id="horseName" required aria-required="true">
                </div>
                <div class="form-group">
                    <label for="horseBreed">Breed:</label>
                    <input type="text" id="horseBreed">
                </div>
                <div class="form-group">
                    <label for="horseAge">Age:</label>
                    <input type="text" id="horseAge" placeholder="e.g., 5 years, 3 months">
                </div>
                <div class="form-group">
                    <label for="horseColour">Colour:</label>
                    <input type="text" id="horseColour">
                </div>
                <button type="submit" class="btn btn-primary" aria-label="Submit new horse">Add Horse</button>
            </form>
        </div>
    </div>

    <!-- Add Vaccination Modal -->
    <div id="addVaccinationModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('addVaccinationModal')" aria-label="Close add vaccination dialog">&times;</span>
            <h2>Add Vaccination Record</h2>
            <form id="addVaccinationForm">
                <div class="form-group">
                    <label for="vaccineType">Vaccine Type:</label>
                    <select id="vaccineType" required onchange="toggleOtherInput(event)" aria-required="true">
                        <option value="">-- Select Type --</option>
                        <option value="Tetanus">Tetanus</option>
                        <option value="Strangles">Strangles</option>
                        <option value="Equine Influenza">Equine Influenza</option>
                        <option value="Hendra Virus">Hendra Virus</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group other-input" id="otherVaccineInput" style="display:none;">
                    <label for="otherVaccineType">Specify Other Vaccine Type:</label>
                    <input type="text" id="otherVaccineType">
                </div>
                <div class="form-group">
                    <label for="vaccineDate">Date Administered:</label>
                    <input type="date" id="vaccineDate" required aria-required="true">
                </div>
                <div class="form-group">
                    <label for="vaccineNextDue">Next Due Date:</label>
                    <input type="date" id="vaccineNextDue">
                </div>
                <div class="form-group">
                    <label for="vaccineVet">Veterinarian:</label>
                    <input type="text" id="vaccineVet">
                </div>
                <div class="form-group">
                    <label for="vaccineNotes">Notes:</label>
                    <textarea id="vaccineNotes" rows="2"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" aria-label="Submit new vaccination record">Add Vaccination</button>
            </form>
        </div>
    </div>

    <!-- Add Deworming Modal -->
    <div id="addDewormingModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('addDewormingModal')" aria-label="Close add deworming dialog">&times;</span>
            <h2>Add Deworming Record</h2>
            <form id="addDewormingForm">
                <div class="form-group">
                    <label for="dewormingProduct">Deworming Product:</label>
                    <select id="dewormingProduct" required onchange="toggleOtherInput(event)" aria-required="true">
                        <option value="">-- Select Product --</option>
                        <option value="Ivermectin">Ivermectin</option>
                        <option value="Moxidectin">Moxidectin</option>
                        <option value="Fenbendazole">Fenbendazole</option>
                        <option value="Pyrantel">Pyrantel</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group other-input" id="otherDewormingInput" style="display:none;">
                    <label for="otherDewormingProduct">Specify Other Product:</label>
                    <input type="text" id="otherDewormingProduct">
                </div>
                <div class="form-group">
                    <label for="dewormingDate">Date Administered:</label>
                    <input type="date" id="dewormingDate" required aria-required="true">
                </div>
                <div class="form-group">
                    <label for="dewormingNextDue">Next Due Date:</label>
                    <input type="date" id="dewormingNextDue">
                </div>
                <div class="form-group">
                    <label for="dewormingWeight">Estimated Weight (kg):</label>
                    <input type="number" id="dewormingWeight" min="0" step="0.01">
                </div>
                <div class="form-group">
                    <label for="dewormingNotes">Notes:</label>
                    <textarea id="dewormingNotes" rows="2"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" aria-label="Submit new deworming record">Add Deworming</button>
            </form>
        </div>
    </div>

    <!-- Add Farrier Modal -->
    <div id="addFarrierModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('addFarrierModal')" aria-label="Close add farrier dialog">&times;</span>
            <h2>Add Farrier Visit Record</h2>
            <form id="addFarrierForm">
                <div class="form-group">
                    <label for="farrierService">Service Type:</label>
                    <select id="farrierService" required onchange="toggleOtherInput(event)" aria-required="true">
                        <option value="">-- Select Service --</option>
                        <option value="Trim">Trim</option>
                        <option value="Front Shoes">Front Shoes</option>
                        <option value="Full Set Shoes">Full Set Shoes</option>
                        <option value="Corrective Shoeing">Corrective Shoeing</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group other-input" id="otherFarrierInput" style="display:none;">
                    <label for="otherFarrierService">Specify Other Service:</label>
                    <input type="text" id="otherFarrierService">
                </div>
                <div class="form-group">
                    <label for="farrierDate">Date of Visit:</label>
                    <input type="date" id="farrierDate" required aria-required="true">
                </div>
                <div class="form-group">
                    <label for="farrierNextDue">Next Due Date:</label>
                    <input type="date" id="farrierNextDue">
                </div>
                <div class="form-group">
                    <label for="farrierName">Farrier Name:</label>
                    <input type="text" id="farrierName">
                </div>
                <div class="form-group">
                    <label for="farrierCost">Cost ($):</label>
                    <input type="number" id="farrierCost" min="0" step="0.01">
                </div>
                <div class="form-group">
                    <label for="farrierNotes">Notes:</label>
                    <textarea id="farrierNotes" rows="2"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" aria-label="Submit new farrier visit">Add Farrier Visit</button>
            </form>
        </div>
    </div>

    <!-- Add Veterinary Modal -->
    <div id="addVeterinaryModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('addVeterinaryModal')" aria-label="Close add veterinary dialog">&times;</span>
            <h2>Add Veterinary Visit Record</h2>
            <form id="addVeterinaryForm">
                <div class="form-group">
                    <label for="vetVisitType">Visit Type:</label>
                    <select id="vetVisitType" required onchange="toggleOtherInput(event)" aria-required="true">
                        <option value="">-- Select Type --</option>
                        <option value="Routine Check-up">Routine Check-up</option>
                        <option value="Emergency">Emergency</option>
                        <option value="Dental">Dental</option>
                        <option value="Lameness Exam">Lameness Exam</option>
                        <option value="Pre-purchase Exam">Pre-purchase Exam</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group other-input" id="otherVetInput" style="display:none;">
                    <label for="otherVetVisitType">Specify Other Visit Type:</label>
                    <input type="text" id="otherVetVisitType">
                </div>
                <div class="form-group">
                    <label for="vetDate">Date of Visit:</label>
                    <input type="date" id="vetDate" required aria-required="true">
                </div>
                <div class="form-group">
                    <label for="vetNextDue">Next Check-up Due:</label>
                    <input type="date" id="vetNextDue">
                </div>
                <div class="form-group">
                    <label for="vetName">Veterinarian:</label>
                    <input type="text" id="vetName">
                </div>
                <div class="form-group">
                    <label for="vetDiagnosis">Diagnosis/Findings:</label>
                    <textarea id="vetDiagnosis" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label for="vetTreatment">Treatment:</label>
                    <textarea id="vetTreatment" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label for="vetCost">Cost ($):</label>
                    <input type="number" id="vetCost" min="0" step="0.01">
                </div>
                <div class="form-group">
                    <label for="vetNotes">Notes:</label>
                    <textarea id="vetNotes" rows="2"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" aria-label="Submit new veterinary visit">Add Veterinary Visit</button>
            </form>
        </div>
    </div>

    <!-- Custom Message Modal -->
    <div id="messageModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('messageModal')" aria-label="Close message dialog">&times;</span>
            <h2 id="messageModalTitle"></h2>
            <p id="messageModalBody"></p>
            <button class="btn btn-primary" onclick="closeModal('messageModal')">OK</button>
        </div>
    </div>

    <!-- Custom Confirmation Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('confirmModal')" aria-label="Close confirmation dialog">&times;</span>
            <h2 id="confirmModalTitle">Confirm Action</h2>
            <p id="confirmModalBody"></p>
            <div class="modal-actions" style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1.5rem;">
                <button class="btn btn-secondary" id="confirmCancelBtn">Cancel</button>
                <button class="btn btn-danger" id="confirmOkBtn">Confirm</button>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
</body>
</html>